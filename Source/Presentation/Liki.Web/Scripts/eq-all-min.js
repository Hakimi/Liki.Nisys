var JSON=JSON||{};JSON.stringify=JSON.stringify||function(f){var e=typeof(f);if(e!="object"||f===null){if(e=="string"){f='"'+f+'"'}return String(f)}else{var g,c,d=[],b=(f&&f.constructor==Array);for(g in f){c=f[g];e=typeof(c);if(e=="string"){c='"'+c+'"'}else{if(e=="object"&&c!==null){c=JSON.stringify(c)}}d.push((b?"":'"'+g+'":')+String(c))}return(b?"[":"{")+String(d)+(b?"]":"}")}};JSON.parse=JSON.parse||function(str){if(str===""){str='""'}eval("var p="+str+";");return p};(function(e,d){var c=d.EQ=d.EQ||{};var b={Locale:"en",AltMenuAttribute:"Attribute",AltMenuConstantExpression:"Constant expression",ButtonApply:"Apply",ButtonCancel:"Cancel",ButtonOK:"OK",ButtonEnable:"Toggle enable",ButtonDelete:"Delete",ButtonAddCondition:"Add condition",ButtonAddPredicate:"Add group of conditions",CmdAddConditionAfter:"Add a new condition after the current row",CmdAddConditionInto:"Add a new condition",CmdAddPredicateAfter:"Open a bracket after the current row",CmdAddPredicateInto:"Open a bracket",CmdClickToAddCondition:"[Add new condition]",CmdDeleteRow:"Delete this row",ErrIncorrectPredicateTitleFormat:"Incorrect predicate title format",ErrNotNumber:" is not a number",ErrIncorrectInteger:"Incorrect integer value",ErrIncorrectNumberList:"Incorrect list format",False:"False",FirstDayOfMonth:"First day of the month",FirstDayOfYear:"First day of the year",HourStart:"This hour start",LinkTypeAll:"all",LinkTypeAny:"any",LinkTypeNone:"none",LinkTypeNotAll:"not all",ConjAll:"and",ConjAny:"or",ConjNotAll:"",ConjNone:"",Midnight:"Midnight",MsgApplySelection:"[Apply selection]",MsgAs:"as",MsgEmptyList:"(empty list)",MsgEmptyListValue:"[select value]",MsgEmptyScalarValue:"[enter value]",MsgSubQueryValue:"[edit sub-query]",MsgOf:"of",Noon:"Noon",Now:"Now",PredicateTitle:"{lt} of the following apply",RootPredicateTitle:"Select records where {lt} of the following apply",StrAddConditions:"Add conditions",SubQueryDialogTitle:"Edit sub-query",SubQueryColumnTitle:"Column:",SubQueryEmptyColumn:"[select column]",SubQueryQueryPanelCaption:"Conditions",Today:"Today",Tomorrow:"Tomorrow",True:"True",Yesterday:"Yesterday",ButtonSorting:"Sorting",ButtonToAggr:"Change to aggregate column",ButtonToSimple:"Change to simple column",CmdAscending:"Ascending",CmdClickToAddColumn:"[Add new column]",CmdDeleteColumn:"Delete column",CmdDeleteSorting:"Delete sorting",CmdDescending:"Descending",CmdGroupSort:"Sorting",CmdNotSorted:"Not sorted",ColTypeAggrFunc:"Aggregate function",ColTypeCompound:"Calculated",ColTypeGroup:"Column type",ColTypeSimple:"Simple column",HeaderExpression:"Expression",HeaderSorting:"Sorting",HeaderTitle:"Title",SortHeaderColumn:"Column",SortHeaderSorting:"Sorting",StrAddColumns:"Add columns",CmdMoveToStart:"Move to start",CmdMoveRight:"Move right",CmdMoveLeft:"Move left",CmdMoveToEnd:"Move to the end",ButtonMenu:"Show menu",CmdToAggr:"Change to aggregate column",CmdToSimple:"Change to simple column"};c.core={texts:{Entities:{},Attributes:{},Operators:{}},constLists:{SpecDateValues:[{id:"${Today}",key:"Today"},{id:"${Yesterday}",key:"Yesterday"},{id:"${Tomorrow}",key:"Tomorrow"},{id:"${FirstDayOfMonth}",key:"FirstDayOfMonth"},{id:"${FirstDayOfYear}",key:"FirstDayOfYear"}],SpecTimeValues:[{id:"${Now}",key:"Now"},{id:"${HourStart}",key:"HourStart"},{id:"${Midnight}",key:"Midnight"},{id:"${Noon}",key:"Noon"}],BooleanValues:[{id:"${false}",key:"False"},{id:"${true}",key:"True"}]},predicateLinkTypeList:[{id:"All",key:"LinkTypeAll"},{id:"Any",key:"LinkTypeAny"},{id:"None",key:"LinkTypeNone"},{id:"NotAll",key:"LinkTypeNotAll"}],getText:function(){var f=c.core.texts;var g=false;for(i=0;i<arguments.length;i++){f=f[arguments[i]];if(!f){g=true;break}}if(g){f=b;for(i=0;i<arguments.length;i++){f=f[arguments[i]];if(!f){break}}}return f},nullAttribute:{id:"",caption:"{Unrecognized attribute}",dataType:"String",description:"",size:0,operators:[],UIC:false,UIR:false,UIS:false},nullOperator:{id:"",caption:"{Unrecognized operator}",displayFormat:"{expr1} [[{unrecognized operator}]] {expr2}",exprType:"Unknown",paramCount:2,valueKind:"Scalar"},listByEntity:function(k,l){var l=l||{};l.addUIC=l.addUIC||true;l.addUIR=l.addUIR||true;l.addUIS=l.addUIS||true;var g=[];var j;var f=null;for(attrIdx in k.attributes){f=k.attributes[attrIdx];if(l.addUIC!==false&&f.UIC!==false||l.addUIR!==false&&f.UIR!==false||l.addUIS!==false&&f.UIS!==false){j=c.core.getText("Attributes",f.id);if(!j){j=f.caption}g.push({id:f.id,text:j})}}var m=null;for(entIdx in k.subEntities){m=k.subEntities[entIdx];if(l.addUIC!==false&&m.UIC!==false||l.addUIR!==false&&m.UIR!==false||l.addUIS!==false&&m.UIS!==false){j=c.core.getText("Entities",m.name);if(!j){j=m.caption}var h={id:m.name,text:j,items:[]};h.items=c.core.listByEntity(m,l);g.push(h)}}return g},getShiftToFitWindow:function(h,k){var g=e(d).width();var j=h+k;var f=0;if(j>g){f=g-j-10;if(h+f<0){f=10-h}}return f},_numericTypes:["Byte","Word","Int","Int32","Int64","Float","Currency"],_intTypes:["Byte","Word","Int","Int32","Int64"],isNumericType:function(g){var f=e.inArray(g,this._numericTypes);return(f>=0)},isIntType:function(g){var f=e.inArray(g,this._intTypes);return(f>=0)},isNumeric:function(f){return e.isNumeric(f)},getEntityAttrById:function(f,g){for(attr in f.attributes){if(f.attributes[attr].id==g){return f.attributes[attr]}}for(ent in f.subEntities){res=this.getEntityAttrById(f.subEntities[ent],g);if(res){return res}}return null},getAttributeById:function(g,h){var f=this.getEntityAttrById(g.rootEntity,h);if(!f){f=this.nullAttribute}return f},findOperatorById:function(g,f){for(oper in g.operators){if(g.operators[oper].id==f){return g.operators[oper]}}return null},getOperatorById:function(g,f){var h=this.findOperatorById(g,f);if(!h){h=this.nullOperator}return h},getFullEntityPathByAttribute:function(f,h,o){if(!f){return""}var n="";if(f.caption){var j=c.core.getText("Entities",f.caption);n=j?j:f.caption}for(var k in f.attributes){if(f.attributes[k].id==h){return n}}if(f.subEntities){for(var g=0;g<f.subEntities.length;g++){var m=f.subEntities[g];var l=this.getFullEntityPathByAttribute(m,h,o);if(l!==""){if(n!==""){l=n+o+l}return l}}}return""},queryChangedCallbacks:e.Callbacks("unique"),queryChanged:function(g,f){if(!g){return}if(f){this.queryChangedCallbacks.remove(g)}else{this.queryChangedCallbacks.add(g)}},getUICAttributeFromEntity:function(g){if(g.UIC!==false){for(attrIdx in g.attributes){if(g.attributes[attrIdx].UIC){return g.attributes[attrIdx]}}for(entIdx in g.subEntities){var f=c.core.getUICAttributeFromEntity(g.subEntities[entIdx]);if(f){return f}}}return null},getDefaultOperatorForAttr:function(f){if(f.defaultOperator){return f.defaultOperator}else{if(f.operators.length>0){return f.operators[0]}else{return c.core.nullOperator}}}}})(jQuery,window);(function(f,h){function o(){var G=-1;if(navigator.appName=="Microsoft Internet Explorer"){var E=navigator.userAgent;var F=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(F.exec(E)!=null){G=parseFloat(RegExp.$1)}}return G}function l(){var F=0;if(window.opera){var E=window.opera.version();F=parseFloat(E)}return F}var e=navigator.userAgent;var B=navigator.appVersion.match(/MSIE/)!=null;var b=o();var g=B&&b>=8;var u=B&&!g;var k=e.match(/firefox/i)!=null;var x=k&&((e.match(/firefox\/2./i)!=null)||(e.match(/firefox\/1./i)!=null));var n=k&&!x;var z=navigator.appVersion.match(/WebKit/)!=null;var c=navigator.appVersion.match(/Chrome/)!=null;var D=window.opera!=null;var C=l();var w=D&&(C<10);function j(F){var E=0;if(typeof(F)=="string"&&F!=null&&F!=""){var G=F.indexOf("px");if(G>=0){E=parseInt(F.substring(0,G))}else{E=1}}return E}function A(G){var F=new Object();F.left=0;F.top=0;F.right=0;F.bottom=0;if(window.getComputedStyle){var E=window.getComputedStyle(G,null);F.left=parseInt(E.borderLeftWidth.slice(0,-2));F.top=parseInt(E.borderTopWidth.slice(0,-2));F.right=parseInt(E.borderRightWidth.slice(0,-2));F.bottom=parseInt(E.borderBottomWidth.slice(0,-2))}else{F.left=j(G.style.borderLeftWidth);F.top=j(G.style.borderTopWidth);F.right=j(G.style.borderRightWidth);F.bottom=j(G.style.borderBottomWidth)}return F}function r(J){var P=new Object();P.x=0;P.y=0;if(J!==null){if(J.getBoundingClientRect){var L=J.getBoundingClientRect();var M=document.body;var G=document.documentElement;var F=window.pageYOffset||G.scrollTop||M.scrollTop;var H=window.pageXOffset||G.scrollLeft||M.scrollLeft;var I=G.clientTop||M.clientTop||0;var N=G.clientLeft||M.clientLeft||0;P.x=Math.round(L.left+H-N);P.y=Math.round(L.top+F-I)}else{P.x=J.offsetLeft;P.y=J.offsetTop;var K=J.parentNode;var E=null;while(offsetParent!=null){P.x+=offsetParent.offsetLeft;P.y+=offsetParent.offsetTop;var O=offsetParent.tagName.toLowerCase();if((u&&O!="table")||((n||c)&&O=="td")){E=A(offsetParent);P.x+=E.left;P.y+=E.top}if(offsetParent!=document.body&&offsetParent!=document.documentElement){P.x-=offsetParent.scrollLeft;P.y-=offsetParent.scrollTop}if(!B&&!w||g){while(offsetParent!=K&&K!==null){P.x-=K.scrollLeft;P.y-=K.scrollTop;if(x||z){E=A(K);P.x+=E.left;P.y+=E.top}K=K.parentNode}}K=offsetParent.parentNode;offsetParent=offsetParent.offsetParent}}}return P}function y(H,I,J,F){var G=document.getElementById(H);var M=document.getElementById(I);var L=r(M);var K=new Object();K.x=0;K.y=0;if(G.style.position!="absolute"){var E=G.offsetParent;if(E!=null){K=r(E)}}G.style.left=(L.x-K.x+J)+"px";G.style.top=(L.y-K.y+F)+"px";G.style.display="block";return true}function m(E){var F=document.getElementById(E);if(F!=null){F.focus();return true}else{return false}}function v(E){var F=document.getElementById(E);if(F!=null){F.style.display="none"}return true}function d(F,E,G){if(F.addEventListener){F.addEventListener(E,G,false)}else{if(F.attachEvent){F.attachEvent("on"+E,G)}}}function t(){var E={};E.height=0;E.width=0;if(typeof(window.innerHeight)=="number"){E.width=window.innerWidth;E.height=window.innerHeight}else{if(document.documentElement&&document.documentElement.clientHeight){E.width=document.documentElement.clientWidth;E.height=document.documentElement.clientHeight}else{if(document.body&&document.body.clientHeight){E.width=document.body.clientWidth;E.height=document.body.clientHeight}}}return E}var s=null;q.prototype={showAt:function(M,K,N){if(!this.items){return}this.initLevelDiv();var H,P;for(H=0;H<this.items.length;H++){P=this.items[H];if(P.itemCheckbox){P.itemCheckbox.checked=P.selected}}var L=this.levelDiv.style;L.left=M+"px";L.top=K+"px";L.display="block";if(this.searchBox!=null){this.searchBox.focus();this.searchBox.value=""}this.scrollDiv.style.width="auto";this.scrollDiv.style.height="auto";if(N){K=this.adjustTopPos(K);L.top=K+"px"}var F=this.parentMenu.minItemWidth;if(F>0&&this.scrollDiv.offsetWidth<F){for(var H=0;H<this.items.length;H++){this.items[H].itemDiv.style.width=F+"px"}}var G=this.parentMenu.maxItemWidth;if(G>0&&this.scrollDiv.offsetWidth>G){for(var H=0;H<this.items.length;H++){this.items[H].itemDiv.style.width=G+"px";this.items[H].itemDiv.style.overflowX="hidden"}}var I=t();var J=I.width-M-this.scrollDiv.offsetWidth;if(J<0){L.left=(M-this.scrollDiv.offsetWidth-F)+"px"}var O=I.height-(K-document.documentElement.scrollTop)-10;if(this.parentMenu.maxHeight>0&&O>this.parentMenu.maxHeight){O=this.parentMenu.maxHeight}if(this.applyDiv!=null){O-=this.applyDiv.offsetHeight}if(this.searchDiv!=null){O-=this.searchDiv.offsetHeight}if(this.levelDiv.offsetHeight>O){var E=O;if(E<50){E=50}this.scrollDiv.style.height=E+"px"}else{this.scrollDiv.style.height="auto"}},hide:function(){if(this.activeItem!==null){if(typeof(this.activeItem.subLevel)!="undefined"){this.activeItem.subLevel.hide()}}if(this.levelDiv){var E=this.levelDiv.style;E.display="none";if(this.initialized){document.body.removeChild(this.levelDiv);this.initialized=false}}},adjustTopPos:function(H){var F=t();var G=H;var E=H-document.documentElement.scrollTop+this.levelDiv.offsetHeight;if(E>F.height-10){G-=E-F.height+10;if(G<document.documentElement.scrollTop){G=document.documentElement.scrollTop+10}}return G},initLevelDiv:function(){if(!this.initialized){document.body.appendChild(this.levelDiv);f(this.levelDiv).addClass("eqjs-menu-levelDiv");this.initialized=true}},activateItem:function(H){var I=H.itemDiv;f(I).addClass("active");if(this.activeItem!=null){this.deactivateItem(this.activeItem)}this.activeItem=H;if(this.parentMenu.options.useDefaultStyles){var K=this.parentMenu.style.colors.bgON;var L=this.parentMenu.style.colors.fgON;var E=this.parentMenu.style.colors.bgOVER;var G=this.parentMenu.style.colors.fgOVER;var J=this.parentMenu.style.itemClass||"";var F=this.parentMenu.style.itemClassOver||"";if(F!=""){I.style.backgroundColor="";I.style.color=""}else{I.style.backgroundColor=E;I.style.color=G}}},deactivateItem:function(E){var F=E.itemDiv;f(F).removeClass("active");if(this.parentMenu.options.useDefaultStyles){var H=this.parentMenu.style.colors.bgON;var I=this.parentMenu.style.colors.fgON;var G=this.parentMenu.style.itemClass||"";if(G!=""){F.style.backgroundColor="";F.style.color=""}else{F.style.backgroundColor=H;F.style.color=I}}if(typeof(E.subLevel)!="undefined"){E.subLevel.hide()}this.activeItem=null},submit:function(F){if(F!=null){if(typeof(F.items)!="undefined"){}else{this.parentMenu.hideMenu();var H=[];if(F==this.applyItem){for(var E=0;E<this.items.length;E++){var G=this.items[E];G.selected=G.itemCheckbox.checked;if(G.selected){H.push(G)}}}if(H.length==0){H=null}this.parentMenu.submitMenu(F,H)}}},showSubLevel:function(E){if(typeof(E.subLevel)=="undefined"){E.subLevel=new q(this.parentMenu,E.items,this.levelIndex+1)}var F=r(E.itemDiv);F.x+=E.itemDiv.offsetWidth-2;F.y+=1;E.subLevel.showAt(F.x,F.y,true)},refreshItems:function(){for(var E=0;E<this.items.length;E++){var F=this.items[E];if(F.itemDiv){if(F.hidden){F.itemDiv.style.display="none"}else{F.itemDiv.style.display="block"}}if(F.subLevel){F.subLevel.refreshItems()}}},renderContent:function(){if(!this.items){return}var Y=this;var V=this.parentMenu.style.colors.bgON||"white";var M=this.parentMenu.style.colors.fgON||"black";var E=this.parentMenu.style.colors.bgOVER||"LightSteelBlue";var aa=this.parentMenu.style.colors.fgOVER||"";var ad=this.parentMenu.style.itemStyle.fontFamily||"";var K=this.parentMenu.style.itemStyle.fontSize||"14px";var H=this.parentMenu.style.itemClass||"";var F=this.parentMenu.style.itemClassOver||"";var W=this.parentMenu.options.multiselect;var P=document.createElement("div");if(this.parentMenu.options.useDefaultStyles){P.style.backgroundColor=V;P.style.border="1px solid";P.style.borderColor=this.parentMenu.style.colors.border;P.style.margin="-2px 2px 2px -2px";P.style.width="auto";P.style.height="auto"}P.style.zIndex=this.parentMenu.zIndex;P.style.position="absolute";P.style.display="none";P.menuLevel=this;var J=this.parentMenu;var L=this.applyItem;var I=function(){var ai=window.event||arguments[0];var aj=ai.srcElement||ai.target;var ah=Y.findItem(aj.value);if(ah==null){ah=Y.items[0]}ah.itemDiv.scrollIntoView();Y.activateItem(ah);if(ai.keyCode==13){Y.submit(ah)}};if(W&&this.levelIndex===0){var U=document.createElement("div"),N=document.createElement("button");f(U).addClass("eqjs-menu-applyDiv");U.menuItem=L;if(this.parentMenu.options.useDefaultStyles){U.style.borderBottom="1px solid";U.style.padding="5px";U.style.marginBottom="5px";N.style.padding="0 5px";N.style.cursor="pointer"}var ag=document.createTextNode(this.parentMenu.options.buttons.submit);N.appendChild(ag);U.appendChild(N);var X=document.createElement("button");f(X).addClass("eqjs-menu-cancel");if(this.parentMenu.options.useDefaultStyles){X.style.padding="0 5px";X.style.cursor="pointer";X.style.marginLeft="15px"}var T=document.createTextNode(this.parentMenu.options.buttons.cancel);X.appendChild(T);U.appendChild(X);P.appendChild(U);L.itemDiv=U;f(N).click(function(){Y.submit(Y.applyItem)});f(X).click(function(){Y.parentMenu.hideMenu()})}if(Y.items.length>=J.showSearchBoxAfter){var S=document.createElement("div");f(S).addClass("eqjs-menu-searchDiv");if(this.parentMenu.options.useDefaultStyles){S.style.borderBottom="1px solid #666";S.style.backgroundColor=V;S.style.borderColor=this.parentMenu.style.colors.border;if(ad!=""){S.style.fontFamily=ad}S.style.fontSize=K;S.style.color=M;S.style.cursor="pointer";S.style.textAlign="left";S.style.padding="5px"}var ac=document.createElement("input");Y.searchBox=ac;Y.searchDiv=S;ac.type="text";ac.size="16";if(this.parentMenu.options.useDefaultStyles){ac.style.fontFamily="monospace";ac.style.fontSize="8pt";ac.style.width="100%"}S.appendChild(ac);P.appendChild(S);d(ac,"keyup",I)}var G=document.createElement("div");f(G).addClass("eqjs-menu-scrollDiv");G.style.overflowX="hidden";G.style.overflowY="auto";P.appendChild(G);var ab;for(ab=0;ab<this.items.length;ab++){var ae=this.items[ab];ae.data=function(ah){return this[ah]};if(typeof(ae.selected)=="undefined"){ae.selected=false}if(ae.selected&&this.selectedItem==null){this.selectedItem=ae}var Q=document.createElement("div");f(Q).addClass("eqjs-menu-itemDiv");G.appendChild(Q);Q.menuItem=ae;ae.itemDiv=Q;if(this.parentMenu.options.useDefaultStyles){Q.style.fontSize=K;Q.style.color=M;Q.style.paddingLeft="15px";Q.style.paddingRight="6px";Q.style.cursor="pointer"}if(W){var Z=document.createElement("input");Z.type="checkbox";Z.id="cb"+ae.id;Z.checked=ae.selected;Z.defaultChecked=ae.selected;Q.appendChild(Z);ae.itemCheckbox=Z;if(this.parentMenu.options.useDefaultStyles){Z.style.margin="4px 10px 0 0";Z.style.verticalAlign="top"}}else{if(ae.selected){var R=document.createElement("div");f(R).addClass("eqjs-menu-markDiv");var af=document.createTextNode("\u25CF");R.appendChild(af);Q.appendChild(R)}}var O=document.createTextNode(ae.text);Q.appendChild(O);f(Q).click(function(ai){var ah=this.menuItem;if(W){if(ai.target!=ah.itemCheckbox){ah.itemCheckbox.checked=!ah.itemCheckbox.checked}}else{Y.submit(ah)}});if(!W){f(Q).mouseenter(function(){var ah=this.menuItem;Y.activateItem(ah);if(typeof(ah.items)!="undefined"){Y.showSubLevel(ah)}});f(Q).mouseleave(function(){var ah=this.menuItem;if(ah==Y.activeItem){if(typeof(ah.subLevel)=="undefined"){Y.deactivateItem(ah)}}})}}this.levelDiv=P;this.scrollDiv=G},remove:function(){for(var F=0;F<this.items.length;F++){var G=this.items[F];if(typeof(G.subLevel)!="undefined"){G.subLevel.remove()}}if(this.levelDiv){this.levelDiv.innerHtml="";var E=this.levelDiv.parentNode;if(E!=null){E.removeChild(this.levelDiv)}}this.levelDiv=null},update:function(E){this.remove();this.items=E;this.activeItem=null;this.selectedItem=null;this.applyItem.itemDiv=null;this.initialized=false;this.updated++;this.renderContent()},findItem:function(F){var E=F.toLowerCase();for(var G=0;G<this.items.length;G++){var H=this.items[G];if(H.text.toLowerCase().indexOf(E)==0){return H}}return null}};function q(F,E,G){this.parentMenu=F;this.levelIndex=G;this.levelDiv=null;this.applyItem=new Object();this.applyItem.itemDiv=null;this.items=E;this.activeItem=null;this.selectedItem=null;this.initialized=false;this.updated=0;this.renderContent()}f.widget("eqjs.PopupMenu",{_mouseIsOverBlock:false,_mouseIsOverLink:false,_toId:null,_itemSelectedCallback:null,_menuClosedCallback:null,_rootLevel:null,options:{items:[],buttons:{submit:EQ.core.getText("ButtonApply"),cancel:EQ.core.getText("ButtonCancel")},useDefaultStyles:false,multiselect:false,adjustHeight:true,zIndex:1000000},_create:function(){this._updateProps();this._rootLevel=new q(this,this.options.items,0);f(this._rootLevel.levelDiv).addClass("eqjs-menu-rootLevel");f(this._rootLevel.levelDiv).css("z-index",this.options.zIndex);var F=this;this._menuKeyUpHandler=function(G){if(G.which==27){F.hideMenu();G.stopImmediatePropagation()}};var E=function(){if(!F.active){return}var H=window.event||arguments[0];var I=H.srcElement||H.target;var G=true;while(I){if(I.tagName&&I.tagName.toLowerCase()=="div"){if(typeof(I.menuLevel)!="undefined"){if(I.menuLevel.parentMenu==F){G=false;break}}}I=I.parentNode||I.parentElement}if(G){F.hideMenu()}};f(document).on("mousedown",E);this._render()},_render:function(){var E=this},_updateProps:function(){this.style={};this.style.colors={border:"#666666",shadow:"#888888",bgON:"white",fgON:"black",bgOVER:"#B6BDD2",fgOVER:"black"};this.style.itemStyle={fontSize:"14px"};this.minItemWidth=0;this.maxItemWidth=0;this.maxHeight=0;this.zIndex=this.options.zIndex;this.showSearchBoxAfter=30;this.commandTemplate="";this.parentElement=null;this.args=[];this.active=false},_setOption:function(E,F){if(arguments.length==2){this.options[E]=F;return this}else{return this.options[E]}},showMenu:function(M){var L=this;L._itemSelectedCallback=M.itemSelectedCallback||null;L._menuClosedCallback=M.menuClosedCallback||null;var I=M.selectedIds||null;if(I){if(typeof I==="string"){I=I.split(",")}var K,E=L.options.items;for(var G=0;G<E.length;G++){K=E[G];K.selected=f.inArray(K.id,I)>=0}}var H=M.anchor||document.body;var F=r(H.get(0));var J={left:F.x,top:F.y+H.outerHeight()+2};this.active=true;L._rootLevel.showAt(J.left,J.top,false);f(document).on("keyup",this._menuKeyUpHandler)},hideMenu:function(){f(document).off("keyup",this._menuKeyUpHandler);this._rootLevel.hide();if(this._menuClosedCallback){this._menuClosedCallback.call()}},submitMenu:function(E,G){var F={widget:this,menuItem:E,selectedItems:G};if(this._itemSelectedCallback){this._itemSelectedCallback.apply(this,[null,F])}else{this._trigger("onMenuItemSelected",null,F)}},knockMenuStyle:function(E){E.removeAttr("style");var F=E.find("ul").first().prop("style");if(F!=="undefined"&&F!==false){E.find("ul").first().prop("style","")}},refreshItems:function(){this._rootLevel.refreshItems()}})})(jQuery);function getEntityById(b,c){if(b.name===c){return b}for(ent in b.subEntities){res=getEntityById(b.subEntities[ent],c);if(res){return res}}return null}function getAggrFunctionCaption(c,e){var b=EQ.core.getText("Aggr"+e.replace(" ","")+"_Caption");if(b){return b}var d=findItemById(c.aggrFunctions,e);if(!d||!d.caption){return e}return d.caption}function getAggrFunctionFormat(b,e){var d=EQ.core.getText("Aggr"+e.replace(" ","")+"_Format");if(d){return d}var c=findItemById(b.aggrFunctions,e);if(!c||!c.displayFormat){return""}return c.displayFormat}function moveArrayItem(c,e,b){if(b>=c.length){var d=b-c.length;while((d--)+1){c.push(undefined)}}c.splice(b,0,c.splice(e,1)[0])}function getMenuHtmlByList(c,d){var b=d?'<ul class="ui-helper-reset">':"<ul>";for(elem in c){if(!("items" in c[elem])){b+=d?'<li data-id="'+c[elem].id+'"><label><input type="checkbox" />'+c[elem].text+"</label></li>":'<li data-id="'+c[elem].id+'"><a href="javascript:void(0)" title="'+c[elem].text+'">'+c[elem].text+"</a></li>"}}for(elem in c){if("items" in c[elem]){b+=d?'<li data-id="'+c[elem].id+'"><label><input type="checkbox" />'+c[elem].text+"</label>":'<li data-id="'+c[elem].id+'"><a href="javascript:void(0)" title="'+c[elem].text+'">'+c[elem].text+"</a>";b+=getMenuHtmlByList(c[elem].items,d);b+="</li>"}}b+="</ul>";return b}function inherit(d){function c(){}c.prototype=d;var b=new c;return b}function getOffset(b){if(b.getBoundingClientRect){return getOffsetRect(b)}else{return getOffsetSum(b)}}function getOffsetSum(b){var d=0,c=0;while(b){d=d+parseInt(b.offsetTop);c=c+parseInt(b.offsetLeft);b=b.offsetParent}return{top:d,left:c}}function getOffsetRect(e){var h=e.getBoundingClientRect();var j=document.body;var c=document.documentElement;var b=window.pageYOffset||c.scrollTop||j.scrollTop;var f=window.pageXOffset||c.scrollLeft||j.scrollLeft;var g=c.clientTop||j.clientTop||0;var k=c.clientLeft||j.clientLeft||0;var l=h.top+b-g;var d=h.left+f-k;return{top:Math.round(l),left:Math.round(d)}}function ElemCoords(c){var d=0;var b=0;if(c.offsetParent){while(1){d+=c.offsetLeft;b+=c.offsetTop;if(!c.offsetParent){break}c=c.offsetParent}}else{if(c.x||c.y){d+=c.x;b+=c.y}}return{x:d,y:b}}function findItemById(d,c){for(var b in d){if(d[b].id===c){return d[b]}}return null}(function(b,c){b.widget("eqjs.TimePicker",{options:{internalFormat:"hh:mm:ss",onChange:function(){},setValue:function(d){this.element._isValidValue(d)}},_convertToInternalFormat:function(e){var d=e+":00";return d},_raiseOnChange:function(){if(this.options&&this.options.onChange){this.options.onChange(this.time())}},_create:function(){var d=this;this.element.attr("maxLength",5);this.time("");this.element.bind({focus:function(){},change:function(){},blur:function(){},keypress:function(h){var g=String.fromCharCode(h.charCode);var f=d.element.val().replace("_",g);if(d._isValidValue(f)){d.element.val(f)}h.preventDefault()},keydown:function(h){if(h.which==8){var g=d.element.val();var f=g.indexOf("_");if(f<0){f=g.length}if(f>0){f--;if(g.charAt(f)==":"){f--}g=d._setCharAt(g,f,"_");d.element.val(g)}h.preventDefault()}else{if(h.which==13){d._raiseOnChange()}}},focusout:function(){d._raiseOnChange()}});this._render()},_setCharAt:function(f,d,e){if(d>f.length-1){return f}return f.substr(0,d)+e+f.substr(d+1)},_render:function(){},_toEditFormat:function(e){if(this._isValidTime(e)){var d=e.match(/^\d\d:\d\d/);if(d.length>0){e=d[0]}return e}else{return this._getInitEditValue()}},_getInitEditValue:function(){return"__:__"},_fixValue:function(d){d=d.replace(/\_/g,"0");if(d.match(/:/g).length<2){d+=":00"}return d},_isValidValue:function(e){var d=this._fixValue(e);return this._isValidTime(d)},_isValidTime:function(f){var e=/^(([0-1]?[0-9])|([2][0-4])):([0-5]?[0-9])(:([0-5]?[0-9]))?$/i;var d=e.test(f);return d},time:function(){if(arguments.length>0){var e=arguments[0];e=this._toEditFormat(e);this.element.val(e);this._render();return this}else{var d=this._fixValue(this.element.val());return d}}})})(jQuery);(function(d,c){var b=c.EQ=c.EQ||{};b.client={serviceUrl:"Query",defaultSqlListRequestHandler:function(g,f){var e={sql:g};d.ajax({type:"POST",url:b.client.serviceUrl+"/ExecuteSql",data:e,dataType:"json",success:function(h){f(h)},error:function(h,k,j){f(null)}})},defaultListRequestHandler:function(g,f){var e={listName:g};d.ajax({type:"POST",url:b.client.serviceUrl+"/GetNamedList",data:e,dataType:"json",success:function(h){f(h)},error:function(h,k,j){f(null)}})},tryGetCurrentQuery:function(e){d.ajax({type:"POST",url:b.client.serviceUrl+"/CurrentQuery",dataType:"json",success:function(f){e(f)}})},controls:{},initControlsDefault:function(h){var l=h||{};var g=h.queryPanelId||"QueryPanel";var e=h.columnsPanelId||"ColumnsPanel";var k=h.entitiesPanelId||"EntitiesPanel";var j=d("#"+g);if(j.length>0){l.queryPanel=l.queryPanel||{};j.QueryPanel(l.queryPanel);this.controls.QPWidget=j}var m=d("#"+e);if(m.length>0){l.columnsPanel=l.columnsPanel||{};m.ColumnsPanel(l.columnsPanel);this.controls.CPWidget=m}var f=d("#"+k);if(f.length>0){l.entitiesPanel=l.entitiesPanel||{};f.EntitiesPanel(l.entitiesPanel);this.controls.EPWidget=f}},init:function(f){f=f||{};if(f.serviceUrl){b.client.serviceUrl=f.serviceUrl}var e=f.modelName||"";var g=f.defaultQueryName||"";f.queryPanel=f.queryPanel||{};f.queryPanel.listRequestHandler=f.queryPanel.listRequestHandler||b.client.defaultListRequestHandler;f.queryPanel.sqlListRequestHandler=f.queryPanel.sqlListRequestHandler||b.client.defaultSqlListRequestHandler;this.initControlsDefault(f);if(e){this.loadModel(e,f.onLoadModel)}},loadModel:function(e,h){var f=this;var g={modelName:e};d.ajax({type:"POST",url:b.client.serviceUrl+"/GetModel",data:g,dataType:"json",crossDomain:false,success:function(k){var j=null;if(f.controls.QPWidget){f.controls.QPWidget.QueryPanel("option","model",k);j=f.controls.QPWidget.QueryPanel("option","query")}if(f.controls.CPWidget){f.controls.CPWidget.ColumnsPanel("option","model",k);f.controls.CPWidget.ColumnsPanel("setQuery",j)}if(f.controls.EPWidget){f.controls.EPWidget.EntitiesPanel("option","model",k)}if(h){h(k)}},error:function(j,l,k){console.log("Error: \n"+j+"\n"+l+"\n"+k)}})},loadQuery:function(h,g){var e=this;var f={queryName:h};d.ajax({type:"POST",url:b.client.serviceUrl+"/GetQuery",data:f,dataType:"json",success:function(j){if(e.controls.QPWidget){e.controls.QPWidget.QueryPanel("option","query",j)}if(e.controls.CPWidget){e.controls.CPWidget.ColumnsPanel("setQuery",j)}if(g){g(j)}}})},clearQuery:function(){var e=this;if(e.controls.QPWidget){e.controls.QPWidget.QueryPanel("clearQuery")}if(e.controls.CPWidget){e.controls.CPWidget.ColumnsPanel("refresh")}},saveQuery:function(f){f=f||{};var g=f.queryName||"";if(f.query){var e={queryJson:JSON.stringify(f.query),queryName:g};d.ajax({type:"POST",url:b.client.serviceUrl+"/SaveQuery",data:e,dataType:"json",beforeSend:f.beforeSend,success:function(h){if(f.success){f.success(h)}},error:f.error})}},buildQuery:function(f){f=f||{};if(f.query){var e={queryJson:JSON.stringify(f.query)};e.extraParams=f.extraParams||"";d.ajax({type:"POST",url:b.client.serviceUrl+"/BuildQuery",data:e,dataType:"json",beforeSend:f.beforeSend,success:function(g){if(f.success){f.success(g)}},error:f.error})}},buildAndExecute:function(f){f=f||{};if(f.query){var e={queryJson:JSON.stringify(f.query),extraParams:""};d.ajax({type:"POST",url:b.client.serviceUrl+"/ExecuteQuery",data:e,dataType:"json",beforeSend:f.beforeSend,success:function(g){if(f.success){f.success(g)}},error:f.error})}}}})(jQuery,window);var poweredByOption={show:true};(function(b,c){b.widget("eqjs.ConditionRow",{_condition:null,_parentPredicate:null,_parentPredicateWidget:null,_buttonsBlock:null,_enableButton:null,_deleteButton:null,_addConditionButton:null,_addPredicateButton:null,_checkBox:null,_keepShowingButtons:false,_isMouseOverBlock:false,_active:false,options:{queryPanel:null,model:null},init:function(f,e,d){this.element.get(0).condition=f;this._condition=f;this._parentPredicate=e;this._parentPredicateWidget=d;this.refresh();if(this._condition.initAsActive){this.setActiveCondition();delete this._condition.initAsActive}},_render:function(){this._clear();if(this.options.model&&this._condition){this._refreshByCondition();if(!this._condition.readOnly){this._initButtons();this._initCheckbox()}}},refresh:function(){this._render()},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;if(d==="disabled"){this._setConditionEnable(!e)}this._render();return this}else{if(d==="disabled"){return this._condition.enabled===false}else{return this.options[d]}}},_setConditionEnable:function(d){if(this._parentPredicate){if(!d||!("enabled" in this._parentPredicate)||this._parentPredicate.enabled){this._setConditionEnableCore(this._condition,d);this._fireConditionChange("change",this._condition)}}},_setConditionEnableCore:function(d,e){d.enabled=e;if(d.conditions){for(condIdx in d.conditions){this._setConditionEnableCore(d.conditions[condIdx],e)}}},_clear:function(){this.element.html("");this.element.removeClass()},_refreshByCondition:function(){},_fireConditionChange:function(d,g,f){var e=this;EQ.core.queryChangedCallbacks.fire({query:e.options.queryPanel.options.query,changeType:"condition."+d,condition:g,element:f||e.element})},remove:function(){var d=this;if(!d._parentPredicateWidget){return}d._parentPredicateWidget.removeCondition(d._condition)},destroy:function(){b.Widget.prototype.destroy.call(this)},isPredicate:function(){return false},_getButtonsContainer:function(){return this.element},_initButtons:function(){var e=this;var d=e._getButtonsContainer();if(!d){return}e._buttonsBlock=b("<div></div>").addClass("eqjs-qp-condition-buttonsBlock").appendTo(d);e._addConditionButton=b("<div></div>").addClass("eqjs-qp-condition-button eqjs-qp-condition-button-addCondition").attr("title",EQ.core.getText("ButtonAddCondition")).appendTo(e._buttonsBlock).click(function(){e._keepShowingButtons=true;e.options.queryPanel.showEntitiesMenu({anchor:e._addConditionButton,selectedIds:null,itemSelectedCallback:function(f,j){var h=j.menuItem.data("id");var g=EQ.core.getAttributeById(e.options.model,h);if("addNewCondition" in e){e.addNewCondition(h)}},menuClosesCallback:function(){e._keepShowingButtons=false;if(!e._isMouseOverBlock){e._leaveButtonBlock()}}},{})});e._addPredicateButton=b("<div></div>").addClass("eqjs-qp-condition-button eqjs-qp-condition-button-addPredicate").attr("title",EQ.core.getText("ButtonAddPredicate")).appendTo(e._buttonsBlock).click(function(){if("addNewPredicate" in e){e.addNewPredicate()}});e._enableButton=b("<div></div>").addClass("eqjs-qp-condition-button eqjs-qp-condition-button-enable").attr("title",EQ.core.getText("ButtonEnable")).appendTo(e._buttonsBlock).click(function(){e.option("disabled",!e.options.disabled);if(e.options.disabled){e._enableButton.removeClass("enabled")}else{e._enableButton.addClass("enabled")}e._enableButton.trigger("mouseover")});e._deleteButton=b("<div></div>").addClass("eqjs-qp-condition-button eqjs-qp-condition-button-delete").attr("title",EQ.core.getText("ButtonDelete")).appendTo(e._buttonsBlock).click(function(){e.remove()});(e.options.disabled)?e._enableButton.removeClass("enabled"):e._enableButton.addClass("enabled");d.find("[class*=eqjs-qp-condition-button]").hover(function(){b(this).addClass("eqjs-qp-condition-button-active")},function(){b(this).removeClass("eqjs-qp-condition-button-active")});d.bind("mouseenter",function(f){e._isMouseOverBlock=true;e._enterButtonBlock();f.stopPropagation();return false}).bind("mouseleave",function(f){e._isMouseOverBlock=false;if(!e._keepShowingButtons&&e._buttonsBlock.is(":visible")){e._leaveButtonBlock()}f.stopPropagation();return false});e._hideButtons();e._adjustButtonsVisibility()},_initCheckbox:function(){var e=this;var d=e._getButtonsContainer();if(!d){return}if(e.options.queryPanel.options.showCheckboxes){e._checkBox=b("<div></div>").addClass("eqjs-qp-condelement eqjs-qp-condition-checkbox").attr("title",EQ.core.getText("ButtonEnable")).prependTo(d).click(function(){e.option("disabled",!e.options.disabled);e._adjustCheckbox();e._checkBox.trigger("mouseover")});e._adjustCheckbox()}},_isFirstConditionInGroup:function(){var d=this._parentPredicate?b.inArray(this._condition,this._parentPredicate.conditions):0;return(d==0)},_renderConjunction:function(){var g=this;var f=g._getButtonsContainer();if(!f){return}if(g.options.queryPanel.options.showConjunctions&&!g._isFirstConditionInGroup()){var d=g._parentPredicate.linkType;var e=EQ.core.getText("Conj"+d);if(e){g._conjuction=b("<span>"+e+"</span>").addClass("eqjs-qp-condelement eqjs-qp-condition-conjuction").prependTo(f)}}},_adjustCheckbox:function(){var d=this;if(!d._checkBox){return}if(d._condition.enabled===false){d._checkBox.removeClass("enabled")}else{d._checkBox.addClass("enabled")}},_adjustButtonsVisibility:function(){},_enterButtonBlock:function(){this._showButtons()},_leaveButtonBlock:function(){},_showButtons:function(){},_hideButtons:function(){if(this._addConditionButton){this._addConditionButton.css("background-image","none")}if(this._addPredicateButton){this._addPredicateButton.css("background-image","none")}if(this._enableButton){this._enableButton.css("background-image","none")}if(this._deleteButton){this._deleteButton.css("background-image","none")}},activate:function(){this._active=true;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},deactivate:function(){this._active=false;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},adjustActiveClass:function(){if(this._active){this.element.addClass("active")}else{this.element.removeClass("active")}},setActiveCondition:function(){this.options.queryPanel.setActiveCondition(this)},isActive:function(){return this._active},getLevel:function(){if(this._parentPredicateWidget){return this._parentPredicateWidget.getLevel()+1}else{return 0}},_renderLevelOffset:function(){var f=this.getLevel();var e;for(var d=0;d<f-1;d++){e=b("<div></div>").addClass("eqjs-qp-level-offset").prependTo(this._getButtonsContainer())}}})})(jQuery);(function(b,c){b.widget("eqjs.ConditionRow_SMPL",b.eqjs.ConditionRow,{_displayFormatParser:{formatStr:"",pos:0,exprNum:0,token:"text",tokenText:"",start:function(d){this.formatStr=d;this.pos=0;this.exprNum=0;this.tokenText=""},skipSpaces:function(){while(this.pos<this.formatStr.length&&this.formatStr.charAt(this.pos)===" "){this.pos++}},next:function(){this.skipSpaces();if(this.pos>=this.formatStr.length){return false}var f=0;if(this.formatStr.charAt(this.pos)==="{"){f=this.formatStr.indexOf("}",this.pos);if(f<0){return false}this.tokenText=this.formatStr.substring(this.pos,f+1);if(this.tokenText.indexOf("{expr")===0){this.token="expression";this.exprNum=parseInt(this.tokenText.substring(5,this.tokenText.length))}this.pos=f+1}else{if(this.formatStr.charAt(this.pos)==="["&&this.pos<this.formatStr.length-1&&this.formatStr.charAt(this.pos+1)==="["){this.pos+=2;f=this.formatStr.indexOf("]]",this.pos);this.token="operator";this.tokenText=this.formatStr.substring(this.pos,f);this.pos=f+2}else{this.token="text";var e=this.formatStr.indexOf("{",this.pos);if(e<0){e=this.formatStr.length}var d=this.formatStr.indexOf("[[",this.pos);if(d<0){d=this.formatStr.length}f=Math.min(e,d);this.tokenText=b.trim(this.formatStr.substring(this.pos,f));this.pos=f}}return true}},_refreshByCondition:function(){if(!this._condition||!this.options.model){return}var r=this;r.options.disabled=!r._condition.enabled||r._condition.readOnly;this.element.addClass("eqjs-qp-row eqjs-qp-row-condition");if(this._condition.enabled===false){this.element.addClass("eqjs-qp-disabled")}if(this._condition.readOnly){this.element.addClass("eqjs-qp-readonly")}if(this._condition.justAdded){this._updateValueExpressions();this._condition.justAdded=false}var f=EQ.core.getOperatorById(r.options.model,r._condition.operatorID);var e=r._parseDisplayFormat(f);var q=null;for(var m in e){q=e[m];var l,g;if(q.type==="operator"){if(this._condition.enabled!==false&&!this._condition.readOnly){g=b("<a></a>",{href:"javascript:void(0)",text:q.text})}else{g=b("<span></span>",{text:q.text})}var d=b("<div></div>");d.addClass("eqjs-qp-condelement eqjs-qp-operelement");g.appendTo(d);d.appendTo(this.element);if(this._condition.enabled!==false&&!this._condition.readOnly){var k=r._createOperatorsMenu(g);g.click(function(t){k.PopupMenu("showMenu",{anchor:g})})}}else{if(q.type==="expression"){if(q.index===0){var s=this._condition.expressions[0].id;var j=EQ.core.getAttributeById(this.options.model,s);var h=b("<div></div>");if(this._condition.enabled!==false&&!this._condition.readOnly){l=b('<a href="javascript:void(0)">'+r._getAttributeText(j)+"</a>");l.click(function(t){r.options.queryPanel.showEntitiesMenu({anchor:l,selectedIds:null,itemSelectedCallback:function(v,z){var y=z.menuItem.data("id");var x=EQ.core.getAttributeById(r.options.model,y);var u=x.operators[0];r._condition.expressions[0].id=y;var w=r._condition.expressions.length;r._condition.expressions.splice(1,w-1);r._condition.operatorID=u;r._updateValueExpressions();r.refresh();r._fireConditionChange("change",r._condition);return false}},{})})}else{l=b("<span>"+r._getAttributeText(j)+"</span>")}h.addClass("eqjs-qp-condelement eqjs-qp-attrelement");l.appendTo(h);h.appendTo(this.element)}else{var o=b("<div></div>");o.appendTo(this.element);this._createValueEditor(o,this._condition.expressions[q.index])}}else{if(q.type==="text"){var n=b("<span></span>").addClass("eqjs-qp-condelement").text(q.text).appendTo(this.element)}}}}if(r.options.queryPanel.options.accentActiveCondition){r.element.click(function(){if(!r._active){r.setActiveCondition()}})}r.adjustActiveClass();r._adjustCheckbox();this._renderConjunction();this._renderLevelOffset()},_getOperatorCaption:function(e){var d=EQ.core.getText("Operators",e.id,"caption");if(!d){d=e.caption}return d},_parseDisplayFormat:function(e){var f=EQ.core.getText("Operators",e.id,"displayFormat");if(!f){f=e.displayFormat}var d=[];var g=this._displayFormatParser;g.start(f);while(g.next()){if(g.token==="operator"){d.push({type:"operator",text:g.tokenText})}else{if(g.token==="expression"){d.push({type:"expression",index:g.exprNum-1})}else{if(g.token==="text"){d.push({type:"text",text:g.tokenText})}}}}return d},_getAttributeText:function(g){var e=this;var k=EQ.core.getText("Attributes",g.id);if(!k){k=g.caption}if(!e.options.queryPanel){return k}var h=e.options.queryPanel.options.attrElementFormat;if(!h){return k}var d=h.replace(new RegExp("{attr}","g"),k),j=EQ.core.getFullEntityPathByAttribute(e.options.model.rootEntity,g.id,"."),f=d.replace(new RegExp("{entity}","g"),j),d=b.trim(f);return d},_operatorChanged:function(d,f){var e=this;this._updateValueExpressions(d);this.refresh();this._fireConditionChange("change",this._condition)},_areCompatibleTypes:function(e,d){if(typeof(e)==="undefined"){return true}if(d=="WideString"||d=="String"){return true}return(e==d)},_areCompatibleEditors:function(e,d){if(!e||!d){if(e==d){return true}else{return false}}if(e==d){return true}if(e.type==d.type){if(e.type=="EDIT"||e.type=="DATETIME"){return true}if(e.type=="CUSTOMLIST"&&e.name==d.name){return true}}return false},_updateValueExpressions:function(j){var r=this;var e=r._condition.expressions[0].id;var f=EQ.core.getAttributeById(r.options.model,e);if(!f){return}var l=EQ.core.getOperatorById(r.options.model,j);var q=(l&&l.exprType&&l.exprType!=="Unknown")?l.exprType:f.dataType;var d=r._condition.operatorID;var g=EQ.core.getOperatorById(r.options.model,d);if(!g){return}var n=(g.exprType&&g.exprType!=="Unknown")?g.exprType:f.dataType;var m=r._getDefaultEditor(j,e);var o=r._getDefaultEditor(d,e);var h=r._condition.expressions.length;var k=1;while(k<g.paramCount){if(k>=h){r._condition.expressions.push(r._createValueExpression(n,g.valueKind))}else{if(!r._areCompatibleEditors(m,o)||!r._areCompatibleTypes(q,n)||l.valueKind!=g.valueKind){r._condition.expressions[k]=r._createValueExpression(n,g.valueKind)}}k++}if(h>k){r._condition.expressions.splice(k,h-k)}},_createValueExpression:function(g,f){var d=this;var e;if(f==="Query"){e={typeName:"QUERY",dataType:g,kind:f,value:b.extend(true,{},d.options.queryPanel._emptyQuery),text:""}}else{if(f==="Attribute"){}else{e={typeName:"CONST",dataType:g,kind:f,value:"",text:""}}}return e},_createOperatorsMenu:function(k){var h=this;if(!h._condition||!h.options.model){return}var g=[];var d=EQ.core.getAttributeById(h.options.model,h._condition.expressions[0].id);if(d){var f=null;for(opIndex in d.operators){f=EQ.core.findOperatorById(h.options.model,d.operators[opIndex]);if(f&&!(h.options.queryPanel.options.isSubQuery&&f.valueKind==="Query")){var e=h._getOperatorCaption(f);g.push({id:f.id,text:e})}}}var j=b("<div></div>").appendTo(k.parent()).hide();j.PopupMenu({items:g,onMenuItemSelected:function(l,n){k.text(n.menuItem.text);var m=h._condition.operatorID;h._condition.operatorID=n.menuItem.id;h._operatorChanged(m,h._condition.operatorID);return false}});return j},_getDefaultEditor:function(e,h){var f=null;var d=EQ.core.findOperatorById(this.options.model,e);var g=EQ.core.getAttributeById(this.options.model,h);if(d&&d.defaultEditor){f=d.defaultEditor}else{if(g&&g.defaultEditor){f=g.defaultEditor}}return f},_getEditorType:function(d,e){if(e&&e.kind==="Query"){return"SUBQUERY"}else{return d?d.type:"EDIT"}},_createValueEditor:function(g,k){var e=this;var j=this._getDefaultEditor(this._condition.operatorID,this._condition.expressions[0].id);var d=this._getEditorType(j,k);var h="element.ValueEditor_"+d+"({queryPanel: self.options.queryPanel, model: self.options.model, conditionWidget:self, condition: self._condition, editor: editorDescr, onChange:changeCallback}); element.ValueEditor_"+d+"('init', expr);";var l=new Function("self, element, expr, editorDescr, changeCallback",h);var f=function(){e._fireConditionChange("change",e._condition)};l(this,g,k,j,f)},_showButtons:function(){if(!this.options.queryPanel.options.showCheckboxes&&this._enableButton){this._enableButton.css("background-image","")}if(this._deleteButton){this._deleteButton.css("background-image","")}},_adjustButtonsVisibility:function(){if(this.options.queryPanel.options.alwaysShowButtonsInConditions||(this.options.queryPanel.options.accentActiveCondition&&this._active)){this._showButtons()}},_leaveButtonBlock:function(){if(this.options.queryPanel.options.alwaysShowButtonsInConditions!=true&&(!this._active||this.options.queryPanel.options.accentActiveCondition!=true)){this._hideButtons()}}})})(jQuery);(function(b,c){b.widget("eqjs.ConditionRow_PDCT",b.eqjs.ConditionRow,{_predicateRowBlock:null,_getButtonsContainer:function(){return this._predicateRowBlock},_parsePredicateText:function(f,j){var m=this;var e=function(){m._fireConditionChange("change",m._condition);m.refresh()};var d=EQ.core.getText(j);var g=d.indexOf("{lt}");if(g<0){f.text(EQ.core.getText("ErrIncorrectPredicateTitleFormat"));f.addClass("eqjs-qp-error")}else{if(g>0){var k=b("<span></span>").addClass("eqjs-qp-predelement").text(d.substring(0,g)).appendTo(f)}var l=b("<div></div>");l.PredicateLinkType({queryPanel:m.options.queryPanel,conditionWidget:m,onChange:e});l.PredicateLinkType("init",m._condition);l.appendTo(f);var h=b("<span></span>").addClass("eqjs-qp-predelement").text(d.substring(g+4)).appendTo(f)}},_refreshPredicateRow:function(){var d=this;if(!d._predicateRowBlock){return}d._predicateRowBlock.html("");d._predicateRowBlock.addClass("eqjs-qp-row eqjs-qp-row-predicate");if(d._condition.enabled===false){d._predicateRowBlock.addClass("eqjs-qp-disabled")}d._parsePredicateText(d._predicateRowBlock,"PredicateTitle");if(d.options.queryPanel.options.accentActiveCondition){d._predicateRowBlock.click(function(){if(!d._active){d.setActiveCondition()}})}d.adjustActiveClass();this._renderConjunction();this._renderLevelOffset()},_refreshByCondition:function(){var d=this;d.element.addClass("eqjs-qp-predicate");d._predicateRowBlock=b("<div></div>");d._predicateRowBlock.appendTo(d.element);d._refreshPredicateRow();d._addConditions(d.element)},_addConditions:function(f){var d=b("<div></div>");d.addClass("eqjs-qp-conditions");d.appendTo(f);for(condIdx in this._condition.conditions){var e=b("<div></div>");e.appendTo(d);var h=this._condition.conditions[condIdx];var g="element.ConditionRow_"+h.typeName+"({queryPanel: self.options.queryPanel, model: self.options.model}); element.ConditionRow_"+h.typeName+"('init', self._condition.conditions[condIdx], self._condition, self);";var j=new Function("self, element, idx",g);j(this,e,condIdx)}(!d.children().length)?d.hide():d.show()},_moveDraggedItem:function(f,e,d){},isPredicate:function(){return true},_containsActiveCondition:function(d){var f=this;var e=d||f._condition;var g=f.options.queryPanel._activeCondition;if(g){g=g._condition}return f.options.queryPanel.predicateContainsCondition(e,g)},removeCondition:function(f){var d=this;var e=b.inArray(f,d._condition.conditions);if(e>=0){if(d._condition.conditions.length==1&&d._parentPredicate){d.remove()}else{if(d._containsActiveCondition()){d.setActiveCondition()}d._condition.conditions.splice(e,1);d.refresh();this._fireConditionChange("delete",f)}}},addCondition:function(f,e){var d=this;if(!f||(b.isArray(f)&&f.length==0)){return}if(typeof e=="number"){d._condition.conditions.push.apply(d._condition.conditions,[e,0].concat(f))}else{d._condition.conditions.push.apply(d._condition.conditions,[].concat(f))}f.initAsActive=true;d.refresh();this._fireConditionChange("add",f)},addNewCondition:function(e,k,g){var m=this;var d,l,h,n;var j=function(o,q){if(!o){return null}if(!o.UIC){return null}return{justAdded:true,typeName:"SMPL",enabled:true,operatorID:q,expressions:[{typeName:m.options.queryPanel.options.attrClassName,id:o.id}]}};if(b.isArray(e)){l=[];for(var f=0;f<e.length;f++){d=EQ.core.getAttributeById(m.options.model,e[f]);if(!d){continue}n=k?k:EQ.core.getDefaultOperatorForAttr(d);h=j(d,n);if(h){l.push(h)}}}else{d=EQ.core.getAttributeById(m.options.model,e);if(!d){return}n=k?k:EQ.core.getDefaultOperatorForAttr(d);l=j(d,n)}m.addCondition(l,g);return h},addNewPredicate:function(){var g=this;var j=EQ.core.getUICAttributeFromEntity(g.options.model.rootEntity);var h=j?j.id:-1;var f=j?j.operators[0]:-1;var k={justAdded:true,typeName:"SMPL",enabled:true,operatorID:f,expressions:[{typeName:g.options.queryPanel.options.attrClassName,id:h}]};var e=g._condition.linkType==="All"?"Any":"All";var d={typeName:"PDCT",linkType:e,conditions:[]};d.conditions.push(k);this.addCondition(d)},_showButtons:function(){if(this._condition.enabled!=false){if(this._addConditionButton){this._addConditionButton.css("background-image","")}if(this._addPredicateButton){this._addPredicateButton.css("background-image","")}}if(!this.options.queryPanel.options.showCheckboxes&&this._enableButton){this._enableButton.css("background-image","")}if(this._deleteButton){this._deleteButton.css("background-image","")}},_adjustButtonsVisibility:function(){if(this.options.queryPanel.options.alwaysShowButtonsInPredicates||(this.options.queryPanel.options.accentActiveCondition&&this._active)){this._showButtons()}},_leaveButtonBlock:function(){if(this.options.queryPanel.options.alwaysShowButtonsInPredicates!=true&&(!this._active||this.options.queryPanel.options.accentActiveCondition!=true)){this._hideButtons()}},activate:function(){this._active=true;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},deactivate:function(){this._active=false;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},adjustActiveClass:function(){if(this._active){this._predicateRowBlock.addClass("active")}else{this._predicateRowBlock.removeClass("active")}}})})(jQuery);(function(b,c){b.widget("eqjs.RootPredicate",b.eqjs.ConditionRow_PDCT,{_showButtons:function(){this._addConditionButton.css("background-image","");this._addPredicateButton.css("background-image","")},_initCheckbox:function(){},_renderConjunction:function(){},_refreshPredicateRow:function(){var d=this;if(!d._predicateRowBlock){return}d._predicateRowBlock.html("");d._predicateRowBlock.addClass("eqjs-qp-row eqjs-qp-row-predicate eqjs-qp-row-predicate-root");d._parsePredicateText(d._predicateRowBlock,"RootPredicateTitle");if(d.options.queryPanel.options.accentActiveCondition){d._predicateRowBlock.click(function(){if(!d._active){d.setActiveCondition()}})}d.adjustActiveClass()},_refreshByCondition:function(){var d=this;this.element.addClass("eqjs-qp-predicate eqjs-qp-predicate-root");if(d.options.queryPanel&&d.options.queryPanel.options.showRootRow){d._predicateRowBlock=b("<div></div>");d._predicateRowBlock.appendTo(d.element);d._refreshPredicateRow()}this._addConditions(this.element)}})})(jQuery);(function(b,c){b.widget("eqjs.QueryPanel",{_activeCondition:null,_rootPredicateWidget:null,_emptyQuery:{root:{linkType:"All",enabled:true,conditions:[]},columns:[],justsorted:[]},options:{model:null,query:b.extend(true,{},this._emptyQuery),isSubQuery:false,activeCondition:null,listRequestHandler:null,sqlListRequestHandler:null,entitiesPopupHandler:null,entitiesListFilter:null,showRootRow:true,showAddRow:true,showCheckboxes:false,showPoweredBy:true,alwaysShowButtonsInPredicates:false,alwaysShowButtonsInConditions:false,showConjunctions:true,accentActiveCondition:true,activateRootOnStart:true,dateFormatValue:"mm/dd/yy",dateFormatDisplay:"d MM, yy",attrElementFormat:"{entity} {attr}",adjustEntitiesMenuHeight:true,subQueryDialogWidth:600,subQueryDialogHeight:300,dialogZIndex:100000,numberDecimalSeparatorDisplay:".",numberListSeparators:[",",";"],attrClassName:"ENTATTR",defaultQuery:{root:{linkType:"All",enabled:true,conditions:[]},columns:[],justsorted:[]}},getSelf:function(){return this},_updateLists:function(){for(var d in EQ.core.constLists){this._updateList(EQ.core.constLists[d])}this._updateList(EQ.core.predicateLinkTypeList)},_updateList:function(e){if(!e){return}for(var d in e){e[d].text=EQ.core.getText(e[d].key);if(!e[d].text){e[d].text=e[d].key}}},_create:function(){var d=this;if(typeof(poweredByOption)=="undefined"){poweredByOption={}}d._render()},_render:function(){var f=this;this._clear();this._updateLists();if(this.options.model!=null){this.options.entitiesList=this.getEntitiesList({addUIC:true,addUIR:false,addUIS:false});this.options.entitiesMenu=this._createEntitiesMenu();this._refreshByQuery();if(this.options.showAddRow){var e=b('<div class="eqjs-qp-addrow"></div>');e.appendTo(this.element);if(!f.options.showRootRow&&(!f.options.query||!f.options.query.root||!f.options.query.root.conditions||f.options.query.root.conditions.length===0)){e.addClass("eqjs-qp-addrow-empty")}var h=b('<a href="javascript:void(0)">'+EQ.core.getText("CmdClickToAddCondition")+"</a>");h.appendTo(e);h.click(function(j){f.showEntitiesMenu({anchor:h,selectedIds:null,itemSelectedCallback:function(k,m){var l=m.menuItem.data("id");f.addNewCondition(l);return false}},{})})}}f.element.droppable({hoverClass:"eqjs-drophover",scope:"entityAttr",drop:function(j,k){f.addNewCondition(k.draggable.data("id"))},over:function(j,k){k.helper.addClass("eqjs-qc-column-drag")},out:function(j,k){k.helper.removeClass("eqjs-qc-column-drag")}});if(f.options.showPoweredBy||poweredByOption.show===true){var d=b("<a></a>",{text:"Powered by EasyQuery",href:"http://devtools.korzh.com/easyquery",target:"_blank",css:{color:"#4676AE",font:"11px Calibri","text-decoration":"underline"}}).appendTo(f.element);var g=function(){d.css({position:"absolute",bottom:"5px",right:"10px"});if(d.parents("div[class*=ui-dialog]").length!=0){d.parents("div[class*=ui-dialog]").find(d).hide()}};g()}},_activateRootPredicate:function(){if(this.options.showRootRow&&this.options.accentActiveCondition&&this.options.activateRootOnStart){if(this._rootPredicateWidget){this.setActiveCondition(this._rootPredicateWidget)}}},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;if(d=="model"){this.clearQuery(false);this._render();this._activateRootPredicate()}else{if(d=="query"){this._fireQueryChange("new");this._render();this._activateRootPredicate()}else{this._render()}}return this}else{return this.options[d]}},_clear:function(){this.element.html("")},_refreshByQuery:function(){var d=b("<div></div>");d.appendTo(this.element);d.RootPredicate({queryPanel:this,model:this.options.model});d.RootPredicate("init",this.options.query.root,null,null);this._rootPredicateWidget=d.data("RootPredicate");if(!this._rootPredicateWidget){this._rootPredicateWidget=d.data("eqjs-RootPredicate")}},clearConditions:function(d){var e=this.options.query;e.root.linkType="All";e.root.enabled=true;e.root.conditions=[];if(d!==false){this.refresh()}},clearQuery:function(d){var e=this.options.query;delete e.root;delete e.columns;delete e.justsorted;b.extend(true,e,this.options.defaultQuery);if(d!==false){this.refresh();this._activateRootPredicate();this._fireQueryChange("clear")}},_fireQueryChange:function(d){var e=this;EQ.core.queryChangedCallbacks.fire({query:e.options.query,changeType:"query."+d})},_fireEntitiesPopup:function(e){var d=this;if(this.options.entitiesPopupHandler){return this.options.entitiesPopupHandler({query:d.options.query,items:e.items})}else{return false}},showEntitiesMenu:function(h,f){var e=this;var d=e.options.entitiesMenu.PopupMenu("option","items");var g=e._fireEntitiesPopup({items:d});if(g){e.options.entitiesMenu.PopupMenu("refreshItems",d)}e.options.entitiesMenu.PopupMenu("showMenu",h)},getEntitiesList:function(d){var e=EQ.core.listByEntity(this.options.model.rootEntity,d);if(this.options.entitiesListFilter){this.options.entitiesListFilter(e,d)}return e},editConditionValue:function(k){if(!k&&this.options.query&&this.options.query.root.conditions.length>0){k=this.options.query.root.conditions[0]}if(!k){return}var d=this.element.find("[class*=eqjs-qp-row-condition]").filter(function(l){return(this.condition==k)});var j=d.find("[class*=eqjs-qp-valueelement]").first();if(j.length==0){return}var g=b(j).data();var e="ValueEditor_";for(var h in g){if(h.slice(0,e.length)==e){var f=g[h];f.showEditor()}}},_createEntitiesMenu:function(){if(!this.options.model){return null}var d=this;var f=b("<div></div>").hide().appendTo(d.element);var e={items:d.options.entitiesList,adjustHeight:d.options.adjustEntitiesMenuHeight};if(d.options.isSubQuery){e.zIndex=d.options.dialogZIndex+1000}f.PopupMenu(e);return f},addNewCondition:function(f,d){var e=this;if(e._rootPredicateWidget){e._rootPredicateWidget.addNewCondition(f,d)}},addNewConditionIntoActivePredicate:function(g,e){var f=this;if(this._activeCondition){var d;if(this._activeCondition.isPredicate()){d=this._activeCondition}else{d=this._activeCondition._parentPredicateWidget}d.addNewCondition(g,e)}else{this.addNewCondition(g,e)}},refresh:function(){this._render()},resize:function(){this._render()},setActiveCondition:function(d){if(this._activeCondition){this._activeCondition.deactivate()}this._activeCondition=d;if(this._activeCondition){this._activeCondition.activate()}},predicateContainsCondition:function(d,g){var e=this;if(!d||!g){return false}if(d.conditions){for(var f=0;f<d.conditions.length;f++){if(d.conditions[f]==g){return true}if(e.predicateContainsCondition(d.conditions[f],g)){return true}}}return false}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor",{_expr:{value:"",text:""},_linkElement:null,options:{queryPanel:null,model:null,condition:null,conditionWidget:null,editor:null,onChange:null},init:function(d){this._expr=d;this.refresh()},getResText:function(){if(!EQ.core.getText){return c}return EQ.core.getText.apply(this.options.queryPanel,arguments)},_getEmptyText:function(){return this.getResText("MsgEmptyScalarValue")},_render:function(){this.clear();if(this.options.model&&this._expr){this._renderCommonPart();this._renderEditor();this._linkElement.text(this._getDisplayText())}},_getClassesToAdd:function(){return"eqjs-qp-condelement eqjs-qp-valueelement"},_renderCommonPart:function(){var d=this;d.element.addClass(d._getClassesToAdd());if(this.options.condition.enabled!==false&&!this.options.condition.readOnly){d._linkElement=b("<a></a>",{href:"javascript:void(0)",text:"-"}).appendTo(d.element);d._linkElement.click(function(){d._showEditor();return false})}else{d._linkElement=b("<span></span>",{text:"-"}).appendTo(d.element)}},showEditor:function(){this._showEditor();this.options.queryPanel.setActiveCondition(this.options.conditionWidget)},_renderEditor:function(){},refresh:function(){this._render()},_showEditor:function(){},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;this._render();return this}else{return this.options[d]}},clear:function(){if(this._linkElement){this._linkElement.unbind()}this.element.removeClass();this.element.empty()},_setValue:function(f){var e=this._adjustNewValue(f);var d=this._validate(e);if(d&&d.result){this._expr.value=e;this._expr.text=f;this._adjustExprText();this._linkElement.text(this._getDisplayText());this._linkElement.attr("title",this._getDisplayText());if(this.options.onChange){this.options.onChange(this._expr.value)}}else{this._validateError(d)}},_validate:function(d){return{result:true,message:""}},_validateError:function(d){alert("Invalid value!\n"+d.message)},_getValue:function(){return this._expr.value},_getText:function(){return this._expr.text},_adjustExprText:function(){if(this._expr.value&&this._expr.value!=""){this._expr.text=this._expr.value}else{this._expr.text=""}},_adjustNewValue:function(d){return d},_getDisplayText:function(){this._adjustExprText();if(this._expr.text&&this._expr.text!=""){return this._expr.text}else{if(this._expr.value&&this._expr.value!=""){return this._expr.value}else{return this._getEmptyText()}}},destroy:function(){this.clear();b.Widget.prototype.destroy.call(this)}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_EDIT",b.eqjs.ValueEditor,{_numberDecimalSeparatorValue:".",_numberListSeparatorValue:",",_numberDecimalSeparatorDisplay:".",_numberListSeparators:[",",";"],_editBox:null,_editBoxClass:"eqjs-qp-ve-editbox",_create:function(){if(this.options.queryPanel&&this.options.queryPanel.options.numberDecimalSeparatorDisplay){this._numberDecimalSeparatorDisplay=this.options.queryPanel.options.numberDecimalSeparatorDisplay}if(this.options.queryPanel&&this.options.queryPanel.options.numberListSeparators){this._numberListSeparators=this.options.queryPanel.options.numberListSeparators}},_adjustNewValue:function(e){if(e.length>0&&this._expr.kind=="List"){var d=new RegExp("s*["+this._numberListSeparators.join("")+"]s*","i");var f=e.split(d);for(a in f){f[a]=this._adjustScalarValue(f[a])}return f.join(this._numberListSeparatorValue)}else{return this._adjustScalarValue(e)}},_adjustScalarValue:function(e){var d=e.split(this._numberDecimalSeparatorDisplay).join(this._numberDecimalSeparatorValue);return d},_adjustExprText:function(){},_renderEditor:function(){var d=this;var e=false;d._editBox=b("<input />",{type:"text","class":d._editBoxClass,blur:function(f){if(d._editBox.is(":visible")&&!e){d._setValue(d._editBox.val());d._editBox.hide();d._linkElement.show();f.stopPropagation();return false}},keydown:function(f){if(f.keyCode==13){if(d._editBox.is(":visible")){e=true;d._setValue(d._editBox.val());d._editBox.hide();d._linkElement.show();f.stopPropagation();e=false;return false}}if(f.keyCode==27){d._editBox.hide();d._linkElement.show();f.stopPropagation();return false}}}).appendTo(this.element).hide()},_checkScalarValue:function(e){var d=+e;if(isNaN(d)){return{result:false,message:e+this.getResText("ErrNotNumber")}}else{if(EQ.core.isIntType(this._expr.dataType)&&d!=parseInt(e,10)){return{result:false,message:e+" - "+this.getResText("ErrIncorrectInteger")}}}return{result:true,message:""}},_validate:function(e){var d;if(EQ.core.isNumericType(this._expr.dataType)){if(e.length>0&&this._expr.kind=="List"){var f=e.split(/\s*,\s*/);for(a in f){d=this._checkScalarValue(f[a]);if(!d||!d.result){return{result:false,message:this.getResText("ErrIncorrectNumberList")}}}return{result:true}}else{return this._checkScalarValue(e)}}else{return{result:true}}},_getZIndex:function(){return(this.options.queryPanel.options.isSubQuery)?this.options.queryPanel.options.dialogZIndex+1000:100000},_showEditor:function(){var d=this;d._linkElement.hide();d._editBox.val(d._getText()).css("min-width",d._linkElement.width()).show().focus()}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_DATETIME",b.eqjs.ValueEditor_EDIT,{_dateFormatInternal:"yy-mm-dd",_dateFormatValue:"mm/dd/yy",_dateFormatDisplay:"d mm, yy",_dataDate:"",_create:function(){if(this.options.queryPanel&&this.options.queryPanel.options.dateFormatValue){this._dateFormatValue=this.options.queryPanel.options.dateFormatValue}if(this.options.queryPanel&&this.options.queryPanel.options.dateFormatDisplay){this._dateFormatDisplay=this.options.queryPanel.options.dateFormatDisplay}},_renderEditor:function(){var d=this;d._editBox=b("<input />",{type:"text","class":"eqjs-qp-ve-editbox"}).appendTo(this.element.parent()).hide();if(d._expr.dataType=="Time"){d._editBox.TimePicker({onChange:function(e){d._setValue(e);d._editBox.hide();d.element.children().focus()}})}else{d._editBox.datepicker({dateFormat:d._dateFormatValue,changeMonth:true,changeYear:true,onClose:function(g,f){if(g!=""){var e=d._convertDate(b(this).datepicker("getDate"),d._dateFormatInternal);if(d._expr.dataType=="Date"){d._setValue(e);d._editBox.hide()}else{d._timeEditBox.focus();d._dataDate=e;d._setValue(e);d._editBox.datepicker("hide")}}else{d._editBox.hide();if(d._timeEditBox){d._timeEditBox.focus()}}}});if(d._expr.dataType=="DateTime"){d._timeEditBox=b("<input />",{type:"text","class":"eqjs-qp-ve-editbox-time"}).appendTo(this.element.parent()).hide();d._timeEditBox.TimePicker({onChange:function(f){var e=d._dataDate+" "+f;d._setValue(e);d._editBox.hide();d._timeEditBox.hide();d._editBox.datepicker("hide");d.element.children().focus()}})}}},_showEditor:function(){var d=this;if(d._expr.dataType=="Time"){var e=d._getValue();d._editBox.TimePicker("time",e)}else{d._editBox.val(this._convertDateString(this._expr.value,this._dateFormatInternal,this._dateFormatValue))}var f=(d.options.queryPanel.options.isSubQuery)?d.options.queryPanel.options.dialogZIndex+1000:100000;d._editBox.css({left:d._linkElement.position().left,top:d._linkElement.position().top,width:"115px",position:"absolute",zIndex:f}).show().focus();if(d._timeEditBox){d._timeEditBox.css({left:d._linkElement.position().left+120,top:d._linkElement.position().top,width:"60px",position:"absolute",zIndex:f}).show()}},_adjustExprText:function(){if(this._expr.value&&this._expr.value!=""){if(this._expr.dataType=="Date"){this._expr.text=this._convertDateString(this._expr.value,this._dateFormatInternal,this._dateFormatDisplay)}}else{this._expr.text=""}},_validate:function(d){return{result:true,message:""}},_convertDateString:function(e,g,f){var d=b.datepicker.parseDate(g,e);return this._convertDate(d,f)},_convertDate:function(d,e){return b.datepicker.formatDate(e,d)}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_LIST",b.eqjs.ValueEditor,{_menuBlock:null,_menuItemsList:null,_emptyListText:"<empty list>",_getEmptyText:function(){if(this._menuItemsList&&(this._menuItemsList.length>0)){return this.getResText("MsgEmptyListValue")}else{return this._emptyListText}},_renderEditor:function(){var d=this;d._fillMenuItemsList();d._renderMenuBlock()},_renderMenuBlock:function(){var d=this;var f=false;if(this._expr){f=this._expr.kind=="List"}var e={items:d._menuItemsList,multiselect:f,onMenuItemSelected:function(g,k){if(!f){d._setValue(k.menuItem.id)}else{if(k.selectedItems){var h=[];for(var j=0;j<k.selectedItems.length;j++){h.push(k.selectedItems[j].id)}d._setValue(h.join(","))}}return false}};if(d.options.queryPanel.options.isSubQuery){e.zIndex=d.options.queryPanel.options.dialogZIndex+1000}d._menuBlock=b("<div></div>").hide().appendTo(d.element).PopupMenu(e)},_showEditor:function(){var d=this;d._menuBlock.PopupMenu("showMenu",{anchor:d._linkElement})},_adjustExprText:function(){var e=this;var g,d=[],f;if(e._expr.value&&e._menuItemsList){if(this._expr.kind=="List"){g=e._expr.value.split(",")}else{g=[e._expr.value]}e._expr.text="";for(idx in g){f=b.grep(e._menuItemsList,function(h){return(g[idx]==h.id)});if(f.length>0){d.push(f[0].text)}}e._expr.text=d.join(",")}else{e._expr.text=""}},_fillMenuItemsList:function(){this._menuItemsList=this.options.editor.values.value}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_CUSTOMLIST",b.eqjs.ValueEditor_LIST,{_loaderElement:null,_renderEditor:function(){var d=this;d._linkElement.hide();d._loaderElement=b("<div></div>",{"class":"eqjs-qp-ve-loader"}).appendTo(d.element);d._fillMenuItemsList(function(){d._linkElement.text(d._getDisplayText());d._loaderElement.hide();d._linkElement.show();d._renderMenuBlock()})},_fillMenuItemsList:function(f){var d=this,e=this.options.editor.name;if(EQ.core.constLists[e]){d._menuItemsList=EQ.core.constLists[e];if(f){f()}}else{if(e==="EntityTree"){d._menuItemsList=d.options.queryPanel.options.entitiesList;if(f){f()}}else{if(d.options.queryPanel.options.listRequestHandler){d.options.queryPanel.options.listRequestHandler(e,function(g){d._menuItemsList=g;if(f){f()}})}}}}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_SQLLIST",b.eqjs.ValueEditor_CUSTOMLIST,{_fillMenuItemsList:function(e){var d=this;if(d.options.queryPanel.options.sqlListRequestHandler){d.options.queryPanel.options.sqlListRequestHandler(d.options.editor.sql,function(f){d._menuItemsList=f;if(e){e()}})}}})})(jQuery);(function(b,c){b.widget("eqjs.ValueEditor_SUBQUERY",b.eqjs.ValueEditor,{_dialogBlock:null,_queryPanelBlock:null,_columnElement:null,_getEmptyText:function(){return this.getResText("MsgSubQueryValue")},_renderEditor:function(){var h=this;h._dialogBlock=b("<div></div>",{"class":"eqjs-qp-ve-subquery"}).hide().appendTo(h.element);var g=h.options.queryPanel.getEntitiesList({addUIC:false,addUIR:true,addUIS:false,isSubQuery:true});var k=b("<div></div>").hide().appendTo(h._dialogBlock);k.PopupMenu({items:g,zIndex:h.options.queryPanel.options.dialogZIndex+1000});var f=b("<div></div>").addClass("eqjs-qp-ve-subquery-column").appendTo(h._dialogBlock);var e=b("<div></div>").addClass("eqjs-qp-ve-subquery-column-title").text(h.getResText("SubQueryColumnTitle")).appendTo(f);var d=b("<div></div>").addClass("eqjs-qp-ve-subquery-column-element").appendTo(f);h._columnElement=b("<a></a>").attr("href","javascript:void(0)").appendTo(d);h._columnElement.click(function(l){k.PopupMenu("showMenu",{anchor:h._columnElement,selectedIds:null,itemSelectedCallback:function(m,n){return h._columnElementMenuClick(m,n)}})});var j=b("<div></div>").addClass("eqjs-qp-ve-subquery-qp-caption").text(h.getResText("SubQueryQueryPanelCaption")).appendTo(h._dialogBlock);h._queryPanelBlock=b('<div class="eqjs-qp-ve-subquery-qp"></div>').appendTo(h._dialogBlock);h._dialogBlock.dialog({autoOpen:false,draggable:false,resizable:false,title:h.getResText("SubQueryDialogTitle"),dialogClass:"eq-js-dialog",closeText:"X",modal:true,width:h.options.queryPanel.options.subQueryDialogWidth,minHeight:h.options.queryPanel.options.subQueryDialogHeight,zIndex:h.options.queryPanel.options.dialogZIndex,buttons:[{name:"eqjs-subquery-button-ok",text:h.getResText("ButtonOK"),click:function(){h._expr.value=h._queryPanelBlock.QueryPanel("option","query");b(this).dialog("close");EQ.core.queryChangedCallbacks.fire({query:h.options.queryPanel.options.query,changeType:"condition.changed",condition:h.options.condition})}},{name:"eqjs-subquery-button-cancel",text:h.getResText("ButtonCancel"),click:function(){b(this).dialog("close")}}],open:function(){b(".ui-widget-overlay").addClass("eq-js-dialog-overlay");b("body").css("overflow","hidden")},beforeClose:function(){b(".ui-widget-overlay").removeClass("eq-js-dialog-overlay");b("body").css("overflow","auto")},close:function(l,m){h._queryPanelBlock.QueryPanel("destroy")}})},_columnElementMenuClick:function(d,k){var e=this;var h=k.menuItem.data("id");var g=EQ.core.getAttributeById(e.options.model,h);var j=e._queryPanelBlock.QueryPanel("option","query");var f={caption:"",sorting:"None",sortIndex:-1,expr:{typeName:"ENTATTR",id:h}};if(j.columns.length>0){j.columns[0]=f}else{j.columns.push(f)}e._columnElement.text(e._getAttributeText(g));e._okButtonEnable(true);return false},_getAttributeText:function(f){var e=this;if(!f){return e.getResText("SubQueryEmptyColumn")}var j=EQ.core.getText("Attributes",f.id);if(!j){j=f.caption}var g=e.options.queryPanel.options.attrElementFormat;if(!g){return j}var d=g.replace(new RegExp("{attr}","g"),j);var h=EQ.core.getFullEntityPathByAttribute(e.options.model.rootEntity,f.id,".");d=d.replace(new RegExp("{entity}","g"),h);return d},_showEditor:function(){var d=this;d._queryPanelBlock.empty();if(!d._expr.value){d._expr.value=b.eqjs.QueryPanel.emptyQuery()}d._queryPanelBlock.QueryPanel({isSubQuery:true,model:d.options.model,query:d._expr.value,showRootRow:d.options.queryPanel.options.showRootRow,showAddRow:true,showCheckboxes:d.options.queryPanel.options.showCheckboxes,dateFormatValue:d.options.queryPanel.options.dateFormatValue,dateFormatDisplay:d.options.queryPanel.options.dateFormatDisplay,listRequestHandler:d.options.queryPanel.options.listRequestHandler,sqlListRequestHandler:d.options.queryPanel.options.sqlListRequestHandler,entitiesListFilter:function(j,h){if(d.options.queryPanel.options.entitiesListFilter){var k=h||{};k.isSubQuery=true;d.options.queryPanel.options.entitiesListFilter(j,k)}}});var g=d._expr.value;var f=-1;if(g.columns.length>0){f=g.columns[0].expr.id}var e=(f==-1)?null:EQ.core.getAttributeById(d.options.model,f);d._columnElement.text(d._getAttributeText(e));d._dialogBlock.dialog("open");d._okButtonEnable(e)},_okButtonEnable:function(d){var e=this._dialogBlock.next(".ui-dialog-buttonpane").find("[name='eqjs-subquery-button-ok']");if(e){if(d){e.button("enable")}else{e.button("disable")}}},_getDisplayText:function(){return this._getEmptyText()}})})(jQuery);(function(b,c){b.widget("eqjs.PredicateLinkType",b.eqjs.ValueEditor_LIST,{_predicate:null,options:{queryPanel:null,condition:null},init:function(d){this._predicate=d;this.options.condition=this._predicate;this.refresh()},_render:function(){this.clear();if(this._predicate){this._renderCommonPart();if(this._predicate.enabled!==false){this._renderEditor()}this._linkElement.text(this._getDisplayText())}},_showEditor:function(){var d=this;d._menuBlock.PopupMenu("showMenu",{anchor:d._linkElement})},_fillMenuItemsList:function(){this._menuItemsList=EQ.core.predicateLinkTypeList},_setValue:function(d){this._predicate.linkType=d;this._linkElement.text(this._getDisplayText());if(this.options.onChange){this.options.onChange(d)}},_getClassesToAdd:function(){return"eqjs-qp-predelement eqjs-qp-predvalueelement"},_getDisplayText:function(){var e=this,d=this._getEmptyText();if(e._predicate.linkType&&e._predicate.linkType!=""){b.each(EQ.core.predicateLinkTypeList,function(){if(this.id===e._predicate.linkType){d=this.text}})}return d}})})(jQuery);(function(b,c){b.widget("eqjs.ColumnsPanel",{_query:null,_activeColumn:null,options:{model:null,isSubQuery:false,showAddRow:true,showHeader:true,showColumnCaptions:true,allowAggrColumns:true,allowSorting:true,adjustEntitiesMenuHeight:true,attrElementFormat:"{entity} {attr}",alwaysShowButtons:false,accentActiveColumn:true},_create:function(){var d=this;d._render()},init:function(d){this._query=d;this.refresh()},_render:function(){var e=this;e._clear();e._updateLists();if(e.options.model){e.options.entitiesList=EQ.core.listByEntity(e.options.model.rootEntity,{addUIC:false,addUIR:true,addUIS:false});e.options.entitiesMenu=e._createEntitiesMenu();if(e.options.allowSorting!=false){e.options.sortMenuList=[{id:"None",text:EQ.core.getText("CmdNotSorted")},{id:"Ascending",text:EQ.core.getText("CmdAscending")},{id:"Descending",text:EQ.core.getText("CmdDescending")}];e.options.sortMenu=e._createSortMenu()}else{e.options.sortMenu=null}if(e.options.showHeader!=false&&e._query&&e._query.columns&&e._query.columns.length>0){var h=b('<div class="eqjs-qc-header"></div>').appendTo(this.element);var g=b('<div class="eqjs-qc-header-expression"></div>').text(EQ.core.getText("HeaderExpression")).appendTo(h);if(e.options.showColumnCaptions){var f=b('<div class="eqjs-qc-header-title"></div>').text(EQ.core.getText("HeaderTitle")).appendTo(h)}}e._refreshByQuery();if(e.options.showAddRow){var d=b('<div class="eqjs-qc-addrow"></div>');d.appendTo(this.element);if(!e._query||!e._query.columns||e._query.columns.length===0){d.addClass("eqjs-qc-addrow-empty")}var j=b('<a href="javascript:void(0)">'+EQ.core.getText("CmdClickToAddColumn")+"</a>");j.appendTo(d);j.click(function(k){e.showEntitiesMenu({anchor:j,selectedIds:null,itemSelectedCallback:function(l,o){var n=o.menuItem.id;var m=EQ.core.getAttributeById(e.options.model,n);e.addNewColumn(n);return false}},{})})}}},_updateLists:function(){},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;this._render();return this}else{return this.options[d]}},setQuery:function(d){this._query=d;this.refresh()},_clear:function(){this.element.html("")},_refreshByQuery:function(){var r=this;if(!r._query){return}var h=b("<div></div>"),j=b("<div></div>");h.addClass("eqjs-qc-columns");h.appendTo(j);j.appendTo(r.element);var k=r._query.columns;for(colIdx in k){var n=b("<div></div>");n.appendTo(h);var g="element.ColumnRow_"+k[colIdx].expr.typeName+"({columnsPanel: self, model: self.options.model}); element.ColumnRow_"+k[colIdx].expr.typeName+"('init', self._query.columns[idx]);";var e=new Function("self, element, idx",g);e(r,n,colIdx)}var l,q,d,f=false,m,o=false;h.sortable({containment:j,tolerance:"touch",cancel:".eqjs-qc-column-buttonsBlock, .eqjs-qc-colelement, .eqjs-qc-sortbutton",placeholder:"ui-state-highlight eqjs-highlight",scrollSpeed:3,delay:100,distance:13,cursorAt:{top:10},forceHelperSize:true,start:function(s,t){l=t.item.index();t.item.addClass("eqjs-qc-column-sort");o=true},update:function(s,t){q=t.item.index();if(f){r.addNewColumn(m,q);f=false}else{if(l!=q){moveArrayItem(k,l,q);r._fireQueryChange("columns.order")}}},stop:function(s,t){t.item.removeClass("eqjs-qc-column-sort")}});r.element.droppable({hoverClass:"eqjs-drophover",scope:"entityAttr",drop:function(s,t){if(!r._query||!r._query.columns||r._query.columns.length===0||!o){r.addNewColumn(t.draggable.attr("data-id"))}else{f=true}},over:function(s,t){t.helper.addClass("eqjs-qc-column-drag")},out:function(s,t){t.helper.removeClass("eqjs-qc-column-drag")},activate:function(s,t){m=t.draggable.attr("data-id")}});(!h.children().length)?j.hide():j.show()},clearColumns:function(d){this._query.columns=[];this._query.justsorted=[];if(d!==false){this.refresh()}},_createEntitiesMenu:function(){if(!this.options.model){return null}var d=this;var e=b("<div></div>").hide().appendTo(this.element);e.PopupMenu({items:this.options.entitiesList,adjustHeight:d.options.adjustEntitiesMenuHeight});return e},showEntitiesMenu:function(f,e){var d=this;d.options.entitiesMenu.PopupMenu("showMenu",f)},_createSortMenu:function(){if(!this.options.model){return null}var e=b("<div></div>").hide().appendTo(this.element);var d=this;e.PopupMenu({items:this.options.sortMenuList});return e},_fireQueryChange:function(d){var e=this;EQ.core.queryChangedCallbacks.fire({query:e.options.query,changeType:"query."+d})},_fireColumnChange:function(d,f){var e=this;f=f||e._column;EQ.core.queryChangedCallbacks.fire({query:e.options.query,changeType:"column."+d,column:f})},addNewColumn:function(j,f){var d=this;var k=function(l){var m=EQ.core.getAttributeById(d.options.model,l);if(!m){return null}if(!m.UIR){if(m.lookupAttr){l=m.lookupAttr;m=EQ.core.getAttributeById(d.options.model,l);if(!m||!m.UIR){return null}}else{return null}}return{caption:"",sorting:"None",sortIndex:-1,expr:{typeName:"ENTATTR",id:l}}};if(!d._query){return}var h,e;if(b.isArray(j)){h=[];for(var g=0;g<j.length;g++){e=k(j[g]);if(e){h.push(e)}}}else{h=k(j)}d.addColumn(h,f);return h},addColumn:function(f,e){var d=this;if(!d._query){return}if(!f||(b.isArray(f)&&f.length==0)){return}if(typeof e=="number"){d._query.columns.splice.apply(d._query.columns,[e,0].concat(f))}else{d._query.columns.push.apply(d._query.columns,[].concat(f))}d.refresh();d._fireColumnChange("add",f)},removeColumn:function(f){var d=this;if(!d._query){return}var e=b.inArray(f,d._query.columns);if(e>=0){d._query.columns.splice(e,1);d.refresh();d._fireColumnChange("remove",f)}},removeColumnByAttrId:function(h){var d=this;if(!d._query){return}var f=0;var g=d._query.columns.length;while(f<g){var e=d._query.columns[f];if(e.expr.typeName=="ENTATTR"&&e.expr.id==h){break}f++}if(f<g){d._query.columns.splice(f,1);d._fireColumnChange("remove",e);d.refresh()}},refresh:function(){this._render()},resize:function(){this._render()},setActiveColumn:function(d){if(this._activeColumn){this._activeColumn.deactivate()}this._activeColumn=d;if(this._activeColumn){this._activeColumn.activate()}}})})(jQuery);(function(b,c){b.widget("eqjs.ColumnRow",{_column:null,_buttonsBlock:null,_columnTypeButton:null,_deleteButton:null,_keepShowingButtons:false,_isMouseOverBlock:false,_sortingButton:null,_classesToAdd:"",_active:false,options:{columnsPanel:null,model:null},init:function(d){this._column=d;this.refresh()},_render:function(){this._clear();if(this.options.model&&this._column){this._refreshByColumn();this._initButtons()}},_fireColumnChange:function(d,f){var e=this;f=f||e._column;EQ.core.queryChangedCallbacks.fire({query:e.options.columnsPanel.options.query,changeType:"column."+d,condition:f})},refresh:function(){this._render()},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;if(d==="disabled"){this._column.enabled=!e}this._render();return this}else{if(d==="disabled"){return this._column.enabled===false}else{return this.options[d]}}},_clear:function(){this.element.unbind();this.element.html("");this.element.removeClass()},_refreshByColumn:function(){},remove:function(){var d=this;if(!d.options.columnsPanel){return}d.options.columnsPanel.removeColumn(d._column);d._fireColumnChange("delete")},destroy:function(){b.Widget.prototype.destroy.call(this)},_getButtonsContainer:function(){return this.element},_initButtons:function(){var e=this;var d=e._getButtonsContainer();if(!d){return}e._buttonsBlock=b("<div></div>").addClass("eqjs-qc-column-buttonsBlock").appendTo(d);e._columnTypeButton=b("<div></div>").addClass("eqjs-qc-column-button eqjs-qc-column-button-type").attr("title",EQ.core.getText("ButtonToAggr")).appendTo(e._buttonsBlock);e._deleteButton=b("<div></div>").addClass("eqjs-qc-column-button eqjs-qc-column-button-delete").attr("title",EQ.core.getText("ButtonDelete")).appendTo(e._buttonsBlock).click(function(){e.remove()});e._sortingButton=b("<div></div>").addClass("eqjs-qc-colelement eqjs-qc-sortbutton").prependTo(e.element);if(e.options.columnsPanel.options.allowSorting!=false){e._sortingButton.attr("title",EQ.core.getText("ButtonSorting")).click(function(){e._keepShowingButtons=true;e.options.columnsPanel.options.sortMenu.PopupMenu("showMenu",{anchor:e._sortingButton,selectedIds:null,itemSelectedCallback:function(f,g){e._column.sorting=g.menuItem.id;e.refresh();e._fireColumnChange("change")},menuClosedCallback:function(){e._keepShowingButtons=false;if(!e._isMouseOverBlock){e._sortingButton.trigger("mouseleave")}}})});if(e._column.sorting==="None"){e._sortingButton.addClass("eqjs-qc-sortbutton-none")}e._sortingButton.hover(function(){b(this).addClass("eqjs-qc-sortbutton-active")},function(){b(this).removeClass("eqjs-qc-sortbutton-active")})}if(e._column.sorting==="Ascending"){e._sortingButton.addClass("eqjs-qc-sortbutton-asc").attr("title",EQ.core.getText("ButtonSorting"))}else{if(e._column.sorting==="Descending"){e._sortingButton.addClass("eqjs-qc-sortbutton-desc").attr("title",EQ.core.getText("ButtonSorting"))}}d.find("[class*=eqjs-qc-column-button]").hover(function(){b(this).addClass("eqjs-qc-column-button-active")},function(){b(this).removeClass("eqjs-qc-column-button-active")});d.bind("mouseenter",function(f){e._isMouseOverBlock=true;e._enterButtonBlock();f.stopPropagation();return false}).bind("mouseleave",function(f){e._isMouseOverBlock=false;if(!e._keepShowingButtons){e._leaveButtonBlock()}f.stopPropagation();return false});e._setupButtonListeners();e._hideButtons();e._adjustButtonsVisibility()},_setupButtonListeners:function(){},_adjustButtonsVisibility:function(){},_enterButtonBlock:function(){this._showButtons()},_leaveButtonBlock:function(){if(this.options.columnsPanel.options.alwaysShowButtons!=true&&(!this._active||this.options.columnsPanel.options.accentActiveColumn!=true)){this._hideButtons()}},_showButtons:function(){},_hideButtons:function(){this._columnTypeButton.css("background-image","none");this._deleteButton.css("background-image","none");if(this._column.sorting==="None"){this._sortingButton.css("background-image","none")}},activate:function(){this._active=true;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},deactivate:function(){this._active=false;this.adjustActiveClass();this._hideButtons();this._adjustButtonsVisibility()},adjustActiveClass:function(){if(this._active){this.element.addClass("active")}else{this.element.removeClass("active")}},isActive:function(){return this._active},setActiveColumn:function(){this.options.columnsPanel.setActiveColumn(this)}})})(jQuery);(function(b,c){b.widget("eqjs.ColumnRow_ENTATTR",b.eqjs.ColumnRow,{_classesToAdd:"eqjs-qc-row eqjs-qc-row-column-entattr",_baseAttr:null,_menuFunctionsBlock:null,_baseExprMenuClick:function(d,h){var e=this;var g=h.menuItem.data("id");var f=EQ.core.getAttributeById(e.options.model,g);e._column.expr.id=g;e._column.caption="";e.refresh();e._fireColumnChange("change");return false},_getBaseExpr:function(){var d=this;var e=null;if(d._column.enabled!==false){e=b("<a></a>").attr("href","javascript:void(0)").text(d._getAttributeText(d._baseAttr))}else{e=b("<span></span>").text(d._getAttributeText(d._baseAttr))}if(d._column.enabled!==false){e.click(function(f){d.options.columnsPanel.options.entitiesMenu.PopupMenu("showMenu",{anchor:e,selectedIds:null,itemSelectedCallback:function(g,h){return d._baseExprMenuClick(g,h)}})})}return e},_fillBaseBlock:function(f){var e=this;f.addClass("eqjs-qc-expr-block");var d=b("<div></div>").addClass("eqjs-qc-colelement eqjs-qc-attrelement").appendTo(f);e._baseAttr=e._getAttribute();var g=e._getBaseExpr();g.appendTo(d);e._createFunctionMenu()},_refreshByColumn:function(){if(!this._column||!this.options.model){return}var d=this;d.element.addClass(d._classesToAdd);var f=b("<div></div>").appendTo(d.element);d._fillBaseBlock(f);if(d.options.columnsPanel.options.accentActiveColumn){d.element.click(function(){if(!d._active){d.setActiveColumn()}})}if(d.options.columnsPanel.options.showColumnCaptions){if(!d._column.caption||d._column.caption==""){d._column.caption=d._getDefaultCaption()}var e=b("<div></div>");e.appendTo(this.element);var g=function(){d._fireColumnChange("change")};e.ColumnRow_CaptionEditor();e.ColumnRow_CaptionEditor("init",d._column,d._getDefaultCaption(),g)}d.adjustActiveClass()},_getDefaultCaption:function(){return this._getAttributeText(this._baseAttr)},_getAttribute:function(){return EQ.core.getAttributeById(this.options.model,this._column.expr.id)},_getAttributeText:function(f){var e=this;if(!f){return""}var j=EQ.core.getText("Attributes",f.id);if(!j){j=f.caption}if(!e.options.columnsPanel){return j}var g=e.options.columnsPanel.options.attrElementFormat;if(!g){return j}var d=g.replace(new RegExp("{attr}","g"),j);var h=EQ.core.getFullEntityPathByAttribute(e.options.model.rootEntity,f.id,".");d=d.replace(new RegExp("{entity}","g"),h);return d},_adjustButtonsVisibility:function(){var d=this;d._columnTypeButton.removeClass("aggregated").attr("title",EQ.core.getText("ButtonToAggr"));if(this.options.columnsPanel.options.alwaysShowButtons||(this.options.columnsPanel.options.accentActiveColumn&&this._active)){this._showButtons()}},_changeTypeToAggr:function(g){var d=this;if(!g){g=d._menuFunctionsBlock.PopupMenu("option","items")[0].id}var h=d._column.expr.id;d._column.caption="";d._column.expr={func:g,distinct:false,typeName:"AGGRFUNC",argument:{typeName:"ENTATTR",id:h}};var f=d._column;var e=d._active;d.destroy();d._clear();d.element.ColumnRow_AGGRFUNC({columnsPanel:d.options.columnsPanel,model:d.options.model});d.element.ColumnRow_AGGRFUNC("init",f);d._fireColumnChange("change");if(e){d.options.columnsPanel._activeColumn=null;d.element.ColumnRow_AGGRFUNC("setActiveColumn")}},_createFunctionMenu:function(){var m=this;var g=[];var f=m.options.model.aggrFunctions;var d=true;var j=true;var l=null;var e=m._getAttribute();var h;for(var k in f){if(!f[k]){continue}d=true;if(f[k].id==="SUM"||f[k].id==="AVG"){d=b.inArray(e.dataType,["Autoinc","Byte","Currency","Float","Int","Int64","Word"])>=0}else{if(f[k].id==="MIN"||f[k].id==="MAX"){d=b.inArray(e.dataType,["Autoinc","BCD","Byte","Currency","Date","DateTime","Float","Int","Int64","Time","Word"])>=0}}if(m._column.expr.func===f[k].id&&!d){j=false}if(d){h=getAggrFunctionCaption(m.options.model,f[k].id);l={id:f[k].id,text:h};g.push(l)}}if(!j){m._column.expr.func=g[0].id}m._menuFunctionsBlock=b("<div></div>").hide().appendTo(m.element);m._menuFunctionsBlock.PopupMenu({items:g});return m._menuFunctionsBlock},_showButtons:function(){if(this.options.columnsPanel.options.allowAggrColumns!=false){this._columnTypeButton.css("background-image","")}else{this._columnTypeButton.attr("title","")}this._deleteButton.css("background-image","");if(this.options.columnsPanel.options.allowSorting!=false){this._sortingButton.css("background-image","")}},_setupButtonListeners:function(){var d=this;d._columnTypeButton.click(function(f){if(d.options.columnsPanel.options.allowAggrColumns!==false&&d._column.enabled!==false){d._keepShowingButtons=true;d._menuFunctionsBlock.PopupMenu("showMenu",{anchor:d._columnTypeButton,selectedIds:null,itemSelectedCallback:function(e,g){d._changeTypeToAggr(g.menuItem.id);return false},menuClosedCallback:function(){d._keepShowingButtons=false;if(!d._isMouseOverBlock){d._columnTypeButton.trigger("mouseleave")}}})}})}})})(jQuery);(function(b,c){b.widget("eqjs.ColumnRow_AGGRFUNC",b.eqjs.ColumnRow_ENTATTR,{_classesToAdd:"eqjs-qc-row eqjs-qc-row-column-aggr",_displayFormatParser:{formatStr:"",pos:0,token:"text",tokenText:"",start:function(d){this.formatStr=d;this.pos=0;this.tokenText=""},skipSpaces:function(){while(this.pos<this.formatStr.length&&this.formatStr.charAt(this.pos)===" "){this.pos++}},next:function(){this.skipSpaces();if(this.pos>=this.formatStr.length){return false}var f=0;if(this.formatStr.charAt(this.pos)==="{"){f=this.formatStr.indexOf("}",this.pos);if(f<0){return false}this.tokenText=this.formatStr.substring(this.pos,f+1);if(this.tokenText.indexOf("{attr")===0){this.token="attribute"}this.pos=f+1}else{if(this.formatStr.charAt(this.pos)==="["&&this.pos<this.formatStr.length-1&&this.formatStr.charAt(this.pos+1)==="["){this.pos+=2;f=this.formatStr.indexOf("]]",this.pos);this.token="function";this.tokenText=this.formatStr.substring(this.pos,f);this.pos=f+2}else{this.token="text";var e=this.formatStr.indexOf("{",this.pos);if(e<0){e=this.formatStr.length}var d=this.formatStr.indexOf("[[",this.pos);if(d<0){d=this.formatStr.length}f=Math.min(e,d);this.tokenText=b.trim(this.formatStr.substring(this.pos,f));this.pos=f}}return true}},_parseDisplayFormat:function(e){if(!e){return[]}var d=[];var f=this._displayFormatParser;f.start(e);while(f.next()){if(f.token==="function"){d.push({type:"function",text:f.tokenText})}else{if(f.token==="attribute"){d.push({type:"attribute"})}else{if(f.token==="text"){d.push({type:"text",text:f.tokenText})}}}}return d},_baseExprMenuClick:function(d,h){var e=this;var g=h.menuItem.data("id");var f=EQ.core.getAttributeById(e.options.model,g);e._column.expr.argument.id=g;e._column.caption="";e.refresh();e._fireColumnChange("change");return false},_fillBaseBlock:function(f){var o=this;f.addClass("eqjs-qc-expr-block eqjs-qc-expr-block-aggr");var g,e;var m=b("<div></div>").addClass("eqjs-qc-colelement eqjs-qc-aggrfuncelement");if(o._column.enabled!==false){e=b("<a></a>",{href:"javascript:void(0)"}).appendTo(m);o._createFunctionMenu()}else{e=b("<span></span>").appendTo(m)}var j=getAggrFunctionFormat(o.options.model,o._column.expr.func);if(!j||j===""){return}var d=o._parseDisplayFormat(j);if(d.length===0){return}var n=null;for(var h in d){n=d[h];if(n.type==="function"){e.text(n.text);m.appendTo(f);if(o._column.enabled!==false){e.click(function(q){o._menuFunctionsBlock.PopupMenu("showMenu",{anchor:e,selectedIds:null,itemSelectedCallback:function(r,s){o._column.expr.func=s.menuItem.id;o._column.caption="";o.refresh();o._fireColumnChange("change");return false}})})}}else{if(n.type==="attribute"){o._baseAttr=o._getAttribute();g=this._getBaseExpr();var l=b("<div></div>").addClass("eqjs-qc-colelement eqjs-qc-attrelement").appendTo(f);g.appendTo(l)}else{if(n.type==="text"){var k=b("<span></span>").addClass("eqjs-qc-colelement").text(n.text).appendTo(f)}}}}},_getDefaultCaption:function(){return this._getAttributeText(this._baseAttr)+" "+getAggrFunctionCaption(this.options.model,this._column.expr.func)},_getAttribute:function(){return EQ.core.getAttributeById(this.options.model,this._column.expr.argument.id)},_setupButtonListeners:function(){var d=this;d._columnTypeButton.click(function(){if(d._column.enabled!==false){d._changeTypeToSimple();return false}})},_adjustButtonsVisibility:function(){var d=this;d._columnTypeButton.addClass("aggregated").attr("title",EQ.core.getText("ButtonToSimple"));if(this.options.columnsPanel.options.alwaysShowButtons||(this.options.columnsPanel.options.accentActiveColumn&&this._active)){this._showButtons()}},_changeTypeToSimple:function(){var d=this;var g=d._column.expr.argument.id;d._column.caption="";d._column.expr={typeName:"ENTATTR",id:g};var f=d._column;var e=d._active;d.destroy();d._clear();d.element.ColumnRow_ENTATTR({columnsPanel:d.options.columnsPanel,model:d.options.model});d.element.ColumnRow_ENTATTR("init",f);d._fireColumnChange("change");if(e){d.options.columnsPanel._activeColumn=null;d.element.ColumnRow_ENTATTR("setActiveColumn")}}})})(jQuery);(function(b,c){b.widget("eqjs.ColumnRow_CaptionEditor",b.eqjs.ValueEditor_EDIT,{_column:null,_defaultValue:"",_editBoxClass:"eqjs-qc-ce-editbox",_onChange:null,init:function(f,d,e){this._expr.value=f.caption;this._expr.text=f.caption;this._column=f;this._defaultValue=d;this._onChange=e;this.refresh()},_render:function(){this.clear();if(this._column){this._renderCommonPart();this._renderEditor();this._linkElement.text(this._getDisplayText())}},_renderCommonPart:function(){var d=this;d.element.addClass(d._getClassesToAdd());d._linkElement=b("<a></a>",{href:"javascript:void(0)",text:"-"}).appendTo(d.element);d._linkElement.click(function(){d._showEditor();return false})},_getClassesToAdd:function(){return"eqjs-qc-colelement eqjs-qc-captionelement"},_setValue:function(d){if(!d||d==""){this._column.caption=this._defaultValue}else{this._column.caption=d}this._linkElement.text(this._column.caption);if(this._onChange){this._onChange(d)}},_getValue:function(){return this._column.caption},_getText:function(){return this._column.caption},_getDisplayText:function(){return this._column.caption},_getZIndex:function(){return 100000}})})(jQuery);(function(b,c){b.widget("eqjs.EntitiesPanel",{_rootEntityBlock:null,options:{model:null,queryPanelId:"QueryPanel",columnsPanelId:"ColumnsPanel",showToolbar:true,showAddColumnsButton:true,showAddConditionButton:true,showCheckboxes:true,dynamicModelLoading:false,clickableAttributes:0,draggableAttributes:true,showAttributes:{usedInConditions:true,usedInColumns:true,usedInSorting:false}},getSelf:function(){return this},_create:function(){var d=this;d._render()},_render:function(){var e=this,d;this._clear();if(this.options.model!=null){this._rootEntityBlock=b("<div></div>");d=this.element.append(this._renderEntity(this.options.model.rootEntity,this._rootEntityBlock,0))}if(this.options.showToolbar){this._createToolPanel(d)}},_renderEntity:function(q,n,m){var s=this;var r="eqjs-ep-entity",k,g=b("<div></div>",{"class":r+"-node"}),t=b("<div></div>",{"class":r+"-children"}),z=b("<label></label>",{"class":r+"-node-label"}),B=b("<input />",{type:"checkbox"}),f=b("<a></a>",{href:"javascript:void(0)","class":r+"-node-button"}),o,l,w,y,u,x,h=b("<div></div>"),A=m;var d=function(D,j){var C=j.find("."+r+'-attr[data-id="'+D+'"]');return C.length>0};var e=function(j){return(s.options.showAttributes.usedInConditions&&j.UIC)||(s.options.showAttributes.usedInColumns&&j.UIR)||(s.options.showAttributes.usedInSorting&&j.UIS)};if(n){k=n;k.html("").addClass(r)}else{k=b("<div></div>",{"class":r})}if(q.name&&q.name!=""){x=EQ.core.getText("Entities",q.name);if(!x){x=q.caption}z.text(x).appendTo(g);if(s.options.showCheckboxes){z.prepend(B)}f.prependTo(g);for(var w=0;w<A;w++){g.prepend(b("<div></div>",{"class":r+"-offset"}))}k.append(g);t.hide();A++}else{}if(q.subEntities){for(w=0;w<q.subEntities.length;w++){y=q.subEntities[w];if(e(y)){t.append(s._renderEntity(y,null,A))}}}f.click(function(){t.toggle();b(this).toggleClass(r+"-node-button-open")});if(q.attributes){for(w=0;w<q.attributes.length;w++){u=q.attributes[w];if(e(u)){if(!u.lookupAttr||!(d(u.lookupAttr,t)||d(u.lookupAttr,this._rootEntityBlock))){x=EQ.core.getText("Attributes",u.id);if(!x){x=u.caption}l=b("<label></label>",{text:x,"class":r+"-attr-label"});if(s.options.showCheckboxes){l.prepend('<input type="checkbox" />')}for(var v=0;v<A+1;v++){l.prepend(b("<div></div>",{"class":r+"-offset"}))}o=b("<div></div>").attr("class",function(){var j=r+"-attr ";if(g.html().length==0){j+=r+"-attr-root"}return j}).html(l).attr("data-id",u.id);if(s.options.draggableAttributes){o.draggable({containment:"document",cursor:"move",helper:"clone",revert:"invalid",scope:"entityAttr",distance:20,connectToSortable:".ui-sortable",cursorAt:{bottom:20,left:10},start:function(j,C){C.helper.find("input").hide()}})}if(s.options.clickableAttributes==1){o.click(function(){var j=b("#"+s.options.queryPanelId);j.QueryPanel("addNewConditionIntoActivePredicate",b(this).data("id"))})}t.append(o)}}}}if(t.html().length){k.append(t)}if(t){t.find("label input").click(function(j){if(b(this).prop("checked")&&!(B.prop("checked"))){B.prop("checked",true)}else{if(t.find("input:checked").length==0){B.prop("checked",false)}}})}B.click(function(){if(b(this).prop("checked")){t.find("label input").prop("checked",true)}else{t.find("label input").prop("checked",false)}});return k},_createToolPanel:function(e){var m=this;var g="eqjs-ep-tool-panel",n=b("<div></div>",{"class":g}),h=b("<div></div>",{"class":g+"-select-all",title:"Select all"}),d=b("<div></div>",{"class":g+"-deselect-all",title:"Clear selection"}),l=b("<div></div>",{"class":g+"-add-columns",title:"Add column"}),f=b("<div></div>",{"class":g+"-add-cond",title:"Add condition"}),k=b("<div></div>",{"class":g+"-left-side"}),j=b("<div></div>",{"class":g+"-right-side"});k.append(d);j.append(l,f);n.append(k,j);h.click(function(){e.find("input").prop("checked",true)});d.click(function(){e.find("input").prop("checked",false)});l.click(function(){var o=b("#"+m.options.columnsPanelId);var t=m.element.find(".eqjs-ep-entity-attr");var s=[];var r,q;b.each(t,function(v,w){w=b(w);var u=w.find("input").first();if(u.prop("checked")){r=w.data("id");q=EQ.core.getAttributeById(m.options.model,r);if(q){if(q.UIR){s.push(r)}else{if(q.lookupAttr){r=q.lookupAttr;q=EQ.core.getAttributeById(m.options.model,r);if(q&&q.UIR){s.push(r)}}}}}});o.ColumnsPanel("addNewColumn",s)});f.click(function(){var o=b("#"+m.options.queryPanelId);var t=m.element.find(".eqjs-ep-entity-attr");var s=[];var r,q;b.each(t,function(v,w){w=b(w);var u=w.find("input").first();if(u.prop("checked")){r=w.data("id");q=EQ.core.getAttributeById(m.options.model,r);if(q){if(q.UIC){s.push(r)}else{if(q.lookupAttr){r=q.lookupAttr;q=EQ.core.getAttributeById(m.options.model,r);if(q&&q.UIC){s.push(r)}}}}}});o.QueryPanel("addNewCondition",s)});this.element.append(n)},_setOption:function(d,e){if(arguments.length==2){this.options[d]=e;if(d=="model"){}this._render();return this}else{return this.options[d]}},_clear:function(){this.element.html("")},refresh:function(){this._render()},resize:function(){this._render()}})})(jQuery);